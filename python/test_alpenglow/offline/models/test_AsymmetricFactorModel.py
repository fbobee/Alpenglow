import alpenglow as prs
from alpenglow.offline.models import AsymmetricFactorModel
import alpenglow.Getter as rs
import pandas as pd
import numpy as np
import unittest


class TestAsymmetricFactorModel(unittest.TestCase):
    def test_rmse(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        model = AsymmetricFactorModel(
            negative_rate=9,
            number_of_iterations=20,
        )
        model.fit(data)

        def predict(model, user, item):
            rd = rs.RecDat()
            rd.user = user
            rd.item = item
            return model.prediction(rd)

        errors = [(1 - predict(model.model, u, i))**2 for (u, i) in data[['user', 'item']].values]
        rmse = np.sqrt(pd.Series(errors)).mean()
        self.assertAlmostEqual(0.2693938783455279, rmse)

    def test_ranking(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        exp = AsymmetricFactorModel(
            negative_rate=9,
            number_of_iterations=20,
        )
        exp.fit(data)
        preds = exp.recommend()

        assert preds['item'].tolist() ==  \
             [94, 427, 455, 250, 38, 255, 468, 166, 204, 298, 450, 40, 156, 300, 338, 282, 225, 266, 247, 299, 97, 375, 371, 120, 337, 496, 108, 497, 256, 30, 25, 325, 414, 292, 429, 483, 177, 293, 36, 16, 464, 295, 105, 62, 369, 479, 236, 221, 80, 15, 278, 216, 245, 277, 362, 22, 122, 444, 351, 284, 191, 118, 112, 99, 78, 314, 330, 281, 54, 491, 419, 127, 96, 174, 161, 102, 181, 197, 211, 478, 458, 93, 116, 168, 271, 12, 192, 29, 5, 425, 357, 17, 377, 185, 440, 405, 484, 232, 409, 146, 197, 299, 16, 86, 427, 116, 215, 440, 29, 205, 204, 165, 414, 97, 300, 452, 6, 281, 403, 234, 483, 40, 356, 12, 318, 192, 314, 95, 425, 353, 93, 296, 429, 139, 58, 468, 330, 436, 233, 15, 325, 454, 434, 99, 419, 108, 122, 78, 112, 478, 491, 421, 295, 497, 284, 450, 445, 273, 65, 499, 266, 406, 301, 380, 142, 1, 185, 48, 409, 294, 481, 19, 441, 390, 39, 408, 237, 178, 7, 260, 361, 152, 63, 362, 130, 485, 437, 252, 232, 473, 323, 426, 228, 157, 369, 145, 70, 72, 484, 127, 166, 483, 38, 250, 414, 247, 256, 211, 330, 25, 293, 442, 215, 36, 292, 177, 491, 348, 196, 30, 271, 251, 444, 225, 156, 282, 181, 146, 351, 96, 174, 400, 108, 299, 337, 375, 450, 86, 325, 16, 97, 102, 69, 454, 99, 298, 120, 464, 266, 284, 233, 15, 122, 281, 221, 93, 216, 12, 440, 479, 192, 421, 369, 118, 245, 236, 22, 80, 40, 403, 206, 29, 197, 278, 205, 318, 277, 191, 204, 425, 356, 405, 459, 234, 296, 116, 6, 185, 473, 134, 232, 268, 488, 127, 445, 5, 228, 17, 161, 104, 372, 462, 215, 196, 429, 166, 383, 300, 496, 30, 444, 211, 293, 94, 292, 225, 400, 181, 337, 299, 491, 263, 165, 434, 86, 338, 251, 25, 395, 36, 255, 436, 371, 414, 271, 4, 348, 254, 351, 483, 128, 188, 427, 295, 421, 330, 99, 105, 96, 101, 120, 410, 174, 146, 206, 205, 53, 23, 162, 246, 195, 447, 494, 139, 488, 81, 418, 250, 454, 38, 425, 233, 78, 440, 112, 403, 356, 419, 95, 234, 296, 97, 6, 318, 58, 127, 221, 108, 256, 192, 357, 177, 353, 80, 93, 12, 156, 273, 478, 236, 300, 165, 204, 250, 266, 86, 442, 450, 108, 30, 62, 38, 293, 299, 395, 400, 455, 81, 25, 371, 436, 225, 251, 427, 128, 188, 496, 462, 429, 452, 292, 483, 263, 53, 255, 491, 351, 215, 410, 195, 247, 197, 296, 498, 403, 23, 497, 421, 246, 162, 58, 337, 418, 95, 102, 181, 447, 22, 494, 318, 234, 4, 356, 221, 245, 284, 278, 80, 99, 139, 254, 177, 118, 236, 6, 216, 488, 298, 468, 191, 271, 434, 127, 146, 101, 78, 174, 105, 112, 425, 478, 419, 96, 206, 16, 94, 348, 383, 375, 43, 196, 204, 462, 372, 429, 102, 337, 247, 371, 395, 108, 166, 375, 427, 225, 266, 450, 263, 251, 30, 250, 483, 400, 188, 62, 468, 256, 156, 177, 38, 497, 81, 452, 211, 195, 197, 410, 16, 53, 118, 245, 69, 403, 23, 58, 488, 22, 221, 80, 216, 318, 236, 246, 418, 162, 494, 278, 296, 25, 234, 284, 447, 215, 496, 191, 356, 4, 6, 101, 95, 139, 255, 161, 54, 29, 455, 282, 464, 292, 116, 440, 5, 458, 233, 454, 498, 277, 377, 273, 146, 168, 348, 114, 228, 230, 460, 331, 49, 305, 152, 204, 442, 86, 383, 30, 400, 81, 452, 429, 247, 372, 395, 166, 455, 128, 188, 102, 215, 250, 263, 94, 371, 251, 225, 497, 53, 410, 483, 436, 197, 23, 418, 246, 195, 494, 299, 496, 162, 447, 105, 488, 337, 101, 211, 266, 498, 254, 348, 293, 108, 177, 96, 174, 271, 38, 146, 427, 421, 351, 296, 25, 403, 139, 468, 16, 58, 450, 491, 318, 234, 181, 95, 6, 356, 284, 29, 362, 278, 80, 116, 221, 236, 206, 233, 298, 118, 375, 454, 295, 245, 292, 69, 62, 228, 22, 434, 255, 460, 114, 27, 225, 62, 40, 215, 166, 337, 36, 196, 496, 442, 434, 250, 120, 98, 94, 338, 444, 372, 300, 452, 81, 263, 455, 204, 498, 292, 462, 181, 99, 491, 188, 246, 53, 277, 97, 255, 418, 494, 410, 23, 25, 425, 206, 162, 4, 195, 447, 78, 127, 400, 271, 497, 112, 478, 383, 351, 395, 353, 197, 211, 419, 298, 168, 132, 479, 293, 281, 314, 17, 397, 77, 488, 54, 265, 192, 38, 93, 289, 5, 377, 113, 116, 251, 323, 19, 12, 499, 171, 390, 48, 357, 406, 142, 177, 409, 1, 288, 302, 378, 45, 166, 250, 337, 196, 36, 496, 300, 452, 215, 247, 165, 497, 298, 455, 434, 120, 97, 128, 450, 266, 255, 338, 292, 102, 38, 263, 156, 188, 246, 395, 375, 418, 256, 53, 494, 410, 23, 162, 442, 325, 444, 447, 25, 108, 468, 277, 195, 464, 86, 383, 197, 99, 251, 78, 372, 479, 236, 278, 22, 168, 282, 293, 80, 216, 112, 314, 245, 191, 221, 127, 353, 419, 118, 16, 54, 425, 116, 414, 478, 458, 462, 281, 181, 161, 206, 5, 29, 369, 17, 429, 192, 400, 77, 421, 427, 122, 93, 357, 377, 12, 462, 166, 94, 442, 168, 30, 69, 282, 337, 225, 479, 102, 120, 36, 211, 161, 5, 455, 177, 458, 128, 54, 277, 444, 375, 247, 263, 215, 17, 197, 289, 77, 4, 265, 357, 414, 377, 397, 132, 205, 113, 116, 86, 452, 29, 330, 156, 440, 16, 281, 12, 429, 192, 348, 314, 295, 93, 101, 454, 188, 233, 254, 353, 488, 6, 139, 410, 418, 23, 246, 494, 369, 53, 15, 98, 234, 162, 434, 356, 122, 403, 447, 362, 436, 96, 483, 165, 318, 195, 273, 301, 81, 445, 380, 185, 65, 260, 48, 232, 294, 225, 166, 462, 196, 442, 337, 94, 98, 215, 36, 338, 496, 250, 204, 211, 452, 444, 181, 177, 263, 491, 81, 197, 383, 256, 62, 38, 4, 434, 277, 102, 400, 99, 351, 292, 120, 165, 271, 25, 293, 247, 188, 105, 53, 498, 255, 410, 246, 497, 429, 54, 418, 40, 425, 78, 5, 23, 162, 206, 494, 395, 69, 96, 112, 419, 161, 447, 295, 174, 298, 458, 483, 479, 139, 101, 478, 195, 127, 488, 348, 357, 146, 77, 17, 403, 116, 377, 265, 266, 6, 29, 95, 397, 234, 128, 156, 356, 289, 132, 362, 372, 215, 30, 429, 165, 383, 94, 86, 225, 496, 299, 81, 251, 247, 263, 371, 250, 483, 188, 211, 452, 204, 455, 348, 105, 410, 181, 53, 491, 271, 337, 36, 128, 23, 246, 102, 418, 25, 494, 162, 195, 292, 255, 293, 295, 447, 351, 96, 174, 146, 497, 427, 436, 330, 101, 488, 434, 254, 256, 498, 177, 38, 197, 206, 444, 233, 454, 421, 139, 414, 362, 99, 403, 296, 95, 234, 318, 356, 58, 6, 69, 29, 221, 205, 228, 460, 273, 230, 331, 114, 63, 104, 27, 405, 0, 459, 49, 116, 90, 50, 40, 250, 166, 215, 300, 496, 434, 94, 204, 165, 36, 372, 292, 263, 444, 120, 81, 293, 266, 498, 128, 395, 452, 4, 25, 99, 188, 450, 181, 383, 255, 455, 97, 246, 338, 491, 53, 410, 98, 23, 418, 38, 494, 162, 108, 78, 195, 447, 156, 425, 112, 127, 277, 462, 419, 400, 206, 86, 351, 478, 197, 421, 298, 251, 497, 177, 353, 211, 22, 436, 271, 102, 221, 278, 236, 80, 488, 403, 95, 464, 245, 216, 191, 139, 356, 375, 168, 132, 254, 234, 357, 6, 296, 397, 101, 118, 265, 318, 77, 499, 414, 181, 292, 53, 348, 105, 96, 78, 139, 174, 246, 494, 447, 236, 351, 278, 221, 101, 498, 410, 369, 188, 357, 23, 162, 80, 419, 395, 418, 112, 298, 196, 204, 165, 462, 455, 86, 250, 30, 400, 429, 442, 81, 452, 395, 371, 497, 496, 105, 188, 98, 94, 266, 247, 25, 293, 166, 468, 483, 299, 255, 436, 450, 38, 53, 251, 215, 108, 410, 427, 383, 263, 197, 491, 351, 298, 271, 181, 372, 23, 418, 96, 162, 101, 174, 246, 494, 488, 128, 447, 195, 421, 362, 254, 146, 211, 498, 295, 348, 292, 337, 102, 296, 99, 284, 139, 16, 403, 80, 58, 278, 221, 95, 206, 318, 234, 225, 236, 6, 22, 245, 356, 29, 118, 216, 78, 116, 191, 419, 112, 405, 225, 299, 337, 166, 62, 372, 455, 442, 36, 196, 215, 338, 94, 462, 300, 120, 40, 98, 434, 452, 444, 263, 204, 383, 496, 81, 277, 250, 4, 256, 197, 498, 181, 177, 168, 211, 188, 102, 99, 491, 246, 53, 479, 418, 54, 410, 23, 5, 494, 292, 162, 458, 161, 78, 447, 425, 195, 112, 419, 206, 69, 17, 77, 165, 357, 128, 265, 132, 377, 289, 127, 351, 395, 397, 478, 497, 400, 298, 271, 116, 113, 247, 156, 38, 353, 25, 29, 488, 139, 101, 293, 6, 95, 281, 403, 356, 97, 375, 234, 390, 94, 102, 165, 86, 462, 455, 375, 225, 452, 177, 30, 468, 497, 69, 337, 372, 429, 16, 427, 196, 371, 197, 161, 479, 483, 168, 5, 458, 298, 54, 250, 156, 81, 38, 395, 116, 188, 29, 251, 414, 450, 277, 266, 211, 498, 108, 410, 53, 418, 284, 263, 246, 23, 494, 338, 236, 162, 62, 377, 17, 447, 278, 80, 36, 357, 77, 289, 221, 118, 330, 325, 348, 265, 245, 101, 195, 369, 436, 488, 216, 362, 105, 400, 191, 421, 397, 403, 464, 318, 15, 113, 233, 58, 139, 6, 454, 234, 40, 22, 440, 300, 250, 266, 455, 165, 450, 94, 247, 468, 62, 38, 298, 427, 108, 30, 225, 497, 86, 452, 299, 102, 375, 128, 166, 371, 337, 255, 16, 156, 40, 177, 197, 81, 483, 293, 498, 25, 245, 395, 284, 278, 236, 22, 80, 216, 221, 118, 429, 496, 191, 282, 251, 464, 53, 421, 188, 292, 418, 403, 246, 410, 116, 162, 58, 29, 318, 494, 447, 23, 296, 105, 436, 78, 112, 362, 95, 234, 195, 127, 419, 356, 351, 6, 478, 277, 54, 400, 139, 99, 325, 174, 405, 488, 290, 407, 186, 390, 171, 183, 35, 196, 166, 40, 337, 266, 496, 38, 165, 247, 497, 255, 215, 108, 81, 156, 498, 468, 292, 128, 102, 25, 375, 177, 427, 293, 197, 434, 97, 120, 395, 99, 86, 277, 338, 16, 246, 263, 462, 188, 53, 418, 78, 256, 22, 162, 410, 494, 112, 236, 23, 278, 245, 127, 444, 80, 447, 216, 464, 221, 483, 181, 372, 491, 419, 425, 191, 429, 251, 478, 351, 442, 195, 118, 325, 54, 284, 4, 116, 282, 421, 206, 479, 29, 458, 161, 400, 271, 403, 5, 211, 377, 19, 390, 171, 499, 17, 409, 290, 441, 95, 250, 40, 338, 62, 38, 300, 36, 120, 156, 204, 255, 496, 256, 196, 292, 450, 372, 177, 444, 266, 375, 97, 293, 247, 25, 215, 108, 277, 414, 282, 468, 102, 211, 442, 181, 168, 429, 462, 4, 479, 483, 497, 491, 78, 99, 351, 112, 325, 128, 197, 419, 54, 434, 464, 236, 221, 16, 357, 80, 161, 127, 425, 498, 458, 278, 452, 371, 5, 69, 369, 105, 17, 478, 271, 281, 22, 295, 377, 77, 96, 245, 132, 314, 174, 216, 265, 397, 289, 440, 139, 191, 122, 192, 116, 15, 284, 12, 113, 246, 165, 177, 455, 215, 102, 284, 436, 491, 16, 99, 351, 127, 36, 112, 78, 403, 444, 434, 400, 181, 425, 318, 58, 211, 120, 419, 372, 271, 478, 330, 105, 356, 296, 4, 498, 81, 122, 440, 95, 234, 282, 254, 162, 246, 195, 174, 295, 15, 447, 369, 146, 314, 281, 6, 410, 362, 96, 53, 452, 494, 256, 418, 499, 23, 1, 188, 206, 481, 290, 228, 90, 441, 19, 485, 35, 252, 230, 104, 473, 336, 305, 407, 192, 404, 79, 131, 268, 446, 185, 270, 426, 484, 157, 361, 276, 474, 408, 129, 87, 70, 50, 225, 299, 166, 300, 196, 442, 62, 250, 337, 204, 215, 40, 496, 98, 462, 372, 429, 247, 86, 128, 383, 36, 452, 263, 292, 251, 395, 497, 293, 434, 38, 25, 427, 455, 400, 102, 188, 483, 266, 450, 256, 108, 97, 338, 444, 498, 211, 371, 410, 53, 246, 195, 375, 23, 418, 156, 494, 162, 177, 120, 447, 491, 414, 421, 468, 99, 298, 181, 271, 464, 22, 325, 197, 216, 245, 118, 221, 236, 278, 80, 488, 436, 191, 206, 351, 277, 425, 78, 127, 254, 16, 112, 4, 403, 116, 205, 281, 101, 353, 419, 429, 256, 488, 483, 197, 211, 292, 101, 254, 98, 255, 206, 271, 436, 116, 455, 421, 25, 205, 69, 29, 177, 233, 348, 181, 118, 491, 444, 353, 99, 414, 216, 191, 22, 278, 5, 146, 454, 298, 245, 371, 293, 236, 16, 228, 83, 80, 19, 273, 70, 45, 1, 406, 485, 499, 323, 161, 276, 35, 302, 230, 72, 301, 290, 54, 441, 90, 375, 331, 460, 347, 231, 493, 473, 283, 361, 57, 210, 104, 408, 461, 378, 114, 49, 52, 79, 87, 393, 474, 405, 0, 142, 336, 130, 252, 183, 426, 294, 155, 311, 36, 156, 444, 225, 429, 168, 38, 496, 479, 371, 483, 337, 375, 372, 292, 295, 464, 247, 250, 299, 468, 281, 177, 205, 293, 25, 192, 69, 12, 93, 215, 277, 440, 353, 161, 17, 458, 30, 54, 132, 5, 455, 450, 298, 216, 348, 108, 221, 397, 289, 105, 491, 62, 245, 236, 357, 265, 77, 271, 362, 22, 118, 251, 113, 454, 191, 377, 16, 80, 233, 278, 181, 99, 128, 497, 462, 442, 96, 146, 127, 425, 102, 351, 174, 116, 421, 112, 185, 473, 284, 78, 441, 87, 268, 1, 481, 29, 232, 111, 499, 30, 442, 337, 196, 204, 94, 166, 86, 40, 300, 102, 452, 263, 247, 215, 462, 395, 256, 81, 188, 250, 375, 434, 498, 36, 410, 53, 246, 23, 418, 494, 195, 497, 168, 496, 162, 447, 177, 197, 69, 251, 266, 277, 156, 120, 338, 161, 54, 458, 479, 5, 400, 436, 421, 450, 108, 97, 4, 282, 293, 254, 488, 455, 116, 16, 77, 429, 236, 17, 292, 289, 278, 377, 265, 353, 80, 29, 211, 118, 205, 22, 245, 298, 98, 216, 221, 397, 191, 464, 357, 101, 132, 444, 403, 78, 325, 113, 356, 318, 234, 211, 338, 300, 98, 337, 496, 444, 168, 295, 400, 128, 479, 375, 38, 196, 105, 161, 165, 5, 263, 81, 250, 271, 255, 146, 452, 96, 120, 458, 54, 174, 197, 17, 16, 491, 277, 497, 289, 156, 188, 292, 440, 77, 281, 181, 265, 12, 357, 397, 377, 351, 113, 29, 293, 93, 362, 192, 410, 101, 132, 395, 488, 314, 325, 116, 246, 25, 53, 418, 468, 23, 40, 494, 162, 122, 204, 15, 195, 447, 369, 403, 356, 6, 318, 97, 139, 4, 234, 254, 353, 95, 296, 284, 436, 58, 380, 473, 406, 464, 445, 462, 165, 196, 204, 86, 442, 372, 452, 30, 128, 166, 81, 247, 102, 263, 94, 188, 400, 395, 455, 429, 497, 215, 256, 53, 410, 225, 197, 337, 23, 418, 494, 246, 195, 251, 162, 436, 447, 488, 211, 101, 254, 69, 498, 371, 16, 483, 29, 177, 116, 105, 5, 161, 348, 421, 54, 468, 496, 375, 96, 458, 139, 299, 250, 403, 296, 362, 58, 6, 146, 174, 234, 318, 271, 95, 356, 282, 284, 233, 454, 206, 273, 114, 228, 460, 27, 277, 405, 331, 230, 231, 49, 222, 50, 210, 200, 70, 294, 140, 445, 225, 94, 196, 462, 338, 300, 36, 444, 256, 215, 120, 62, 383, 177, 211, 156, 38, 98, 496, 250, 292, 277, 165, 102, 168, 263, 434, 181, 375, 491, 40, 197, 25, 69, 99, 86, 429, 479, 427, 255, 54, 351, 5, 161, 266, 108, 247, 78, 458, 112, 357, 425, 419, 450, 17, 436, 265, 77, 271, 377, 97, 204, 289, 395, 132, 397, 139, 483, 403, 421, 188, 127, 246, 113, 356, 6, 234, 53, 440, 206, 81, 452, 400, 410, 162, 418, 23, 95, 478, 494, 318, 296, 447, 96, 101, 498, 414, 58, 251, 254, 225, 62, 40, 215, 166, 337, 36, 196, 496, 442, 434, 250, 120, 98, 94, 338, 444, 372, 300, 452, 81, 263, 455, 204, 498, 292, 462, 181, 99, 491, 188, 246, 53, 277, 97, 255, 418, 494, 410, 23, 25, 425, 206, 162, 4, 195, 447, 78, 127, 400, 271, 497, 112, 478, 383, 351, 395, 353, 197, 211, 419, 298, 168, 132, 479, 293, 281, 314, 17, 397, 77, 488, 54, 265, 192, 38, 93, 289, 5, 377, 113, 116, 251, 323, 19, 12, 499, 171, 390, 48, 357, 406, 142, 177, 409, 1, 288, 302, 378, 45, 196, 204, 165, 462, 455, 86, 250, 30, 400, 429, 442, 81, 452, 395, 371, 497, 496, 105, 188, 98, 94, 266, 247, 25, 293, 166, 468, 483, 299, 255, 436, 450, 38, 53, 251, 215, 108, 410, 427, 383, 263, 197, 491, 351, 298, 271, 181, 372, 23, 418, 96, 162, 101, 174, 246, 494, 488, 128, 447, 195, 421, 362, 254, 146, 211, 498, 295, 348, 292, 337, 102, 296, 99, 284, 139, 16, 403, 80, 58, 278, 221, 95, 206, 318, 234, 225, 236, 6, 22, 245, 356, 29, 118, 216, 78, 116, 191, 419, 112, 405, 196, 462, 215, 429, 299, 30, 372, 166, 94, 250, 255, 400, 225, 292, 165, 25, 293, 491, 181, 371, 251, 395, 211, 271, 81, 483, 427, 105, 263, 434, 337, 86, 351, 444, 295, 188, 383, 36, 348, 38, 99, 96, 410, 174, 53, 146, 436, 421, 40, 206, 254, 246, 162, 23, 195, 494, 447, 330, 418, 101, 488, 414, 452, 497, 108, 62, 247, 425, 362, 455, 78, 221, 127, 128, 112, 80, 498, 278, 419, 139, 22, 236, 338, 403, 216, 454, 204, 95, 296, 233, 478, 266, 118, 245, 356, 4, 460, 318, 58, 228, 98, 247, 256, 102, 128, 375, 86, 165, 166, 468, 455, 225, 177, 497, 427, 383, 16, 156, 298, 69, 452, 450, 337, 300, 266, 479, 168, 161, 197, 458, 62, 250, 108, 38, 54, 5, 371, 30, 483, 325, 116, 236, 40, 284, 462, 277, 414, 429, 278, 29, 80, 221, 498, 245, 118, 464, 196, 216, 191, 369, 395, 377, 17, 357, 22, 77, 15, 289, 97, 418, 265, 81, 122, 188, 246, 494, 410, 53, 251, 23, 162, 314, 447, 421, 338, 318, 397, 58, 403, 113, 440, 132, 6, 281, 234, 139, 436, 356, 372, 12, 299, 30, 337, 250, 97, 98, 204, 94, 496, 434, 120, 166, 36, 215, 196, 292, 498, 450, 255, 266, 128, 442, 325, 452, 444, 338, 165, 156, 298, 464, 81, 263, 497, 25, 395, 314, 108, 246, 353, 99, 494, 293, 188, 22, 418, 23, 195, 162, 53, 447, 410, 216, 127, 78, 191, 245, 278, 236, 112, 80, 221, 425, 118, 168, 38, 247, 414, 375, 419, 478, 277, 251, 281, 421, 206, 192, 205, 181, 93, 12, 122, 479, 4, 369, 132, 15, 1, 499, 323, 441, 301, 290, 19, 491, 72, 481, 407, 485, 87, 383, 38, 255, 40, 299, 429, 30, 414, 496, 455, 300, 337, 247, 156, 371, 292, 256, 483, 450, 338, 36, 97, 204, 62, 293, 468, 25, 375, 266, 108, 177, 120, 298, 196, 282, 325, 444, 372, 215, 497, 462, 442, 221, 211, 128, 251, 464, 236, 105, 102, 80, 330, 278, 295, 351, 181, 86, 348, 369, 491, 216, 245, 22, 16, 96, 174, 78, 112, 479, 118, 168, 165, 191, 271, 314, 419, 277, 99, 122, 281, 15, 284, 357, 421, 69, 362, 12, 192, 395, 440, 127, 93, 205, 146, 498, 425, 54, 4, 139, 17, 197, 300, 225, 98, 165, 250, 450, 337, 62, 38, 94, 299, 102, 177, 108, 86, 197, 166, 375, 128, 247, 452, 156, 298, 293, 497, 4, 468, 427, 16, 81, 462, 277, 498, 25, 403, 436, 395, 284, 296, 54, 372, 234, 318, 263, 95, 58, 6, 356, 99, 442, 188, 483, 245, 53, 78, 161, 22, 139, 458, 112, 478, 256, 419, 40, 127, 425, 418, 383, 5, 246, 351, 410, 236, 421, 116, 255, 377, 29, 162, 195, 80, 23, 278, 216, 191, 118, 221, 494, 496, 447, 69, 292, 491, 371, 77, 211, 400, 488, 265, 17, 166, 462, 299, 36, 120, 256, 215, 444, 383, 455, 211, 496, 300, 98, 168, 40, 292, 196, 62, 177, 4, 156, 434, 293, 128, 181, 277, 263, 414, 479, 38, 69, 491, 255, 250, 97, 102, 25, 375, 5, 99, 54, 161, 427, 247, 458, 357, 351, 271, 17, 197, 483, 78, 295, 205, 282, 265, 112, 132, 289, 77, 397, 419, 425, 165, 377, 348, 440, 188, 281, 246, 206, 113, 86, 192, 395, 410, 162, 421, 53, 400, 23, 96, 494, 418, 12, 330, 251, 105, 353, 139, 447, 314, 93, 325, 101, 127, 452, 174, 81, 444, 215, 177, 496, 168, 40, 250, 277, 4, 196, 292, 479, 427, 255, 383, 293, 429, 69, 181, 375, 102, 62, 491, 282, 247, 414, 54, 25, 197, 5, 161, 97, 458, 434, 128, 483, 99, 295, 351, 263, 17, 357, 271, 77, 78, 265, 132, 105, 289, 377, 112, 397, 419, 425, 113, 281, 348, 440, 96, 330, 452, 192, 16, 206, 12, 174, 205, 127, 116, 139, 325, 93, 478, 29, 497, 450, 369, 314, 362, 403, 204, 108, 6, 371, 146, 356, 353, 234, 246, 266, 464, 101, 468, 95, 162, 318, 418, 122, 15, 81, 483, 166, 337, 225, 298, 255, 497, 245, 236, 221, 197, 25, 80, 118, 22, 278, 436, 216, 421, 30, 191, 251, 464, 69, 403, 318, 58, 325, 4, 395, 296, 292, 234, 97, 54, 356, 277, 161, 414, 6, 95, 458, 139, 211, 383, 462, 40, 5, 440, 168, 29, 377, 479, 116, 372, 105, 362, 112, 330, 419, 452, 77, 78, 17, 369, 15, 254, 357, 351, 289, 442, 265, 127, 122, 174, 233, 348, 454, 96, 146, 478, 113, 499, 397, 252, 1, 496, 230, 35, 407, 185, 186, 228, 441, 290, 104, 270, 111, 131, 33, 338, 40, 337, 256, 99, 434, 97, 120, 362, 206, 108, 454, 233, 86, 205, 156, 263, 395, 497, 425, 325, 281, 127, 93, 450, 468, 221, 192, 4, 78, 12, 464, 440, 488, 112, 101, 403, 188, 266, 216, 410, 246, 421, 162, 22, 236, 356, 419, 478, 53, 95, 122, 80, 318, 165, 118, 447, 102, 139, 62, 296, 278, 245, 234, 459, 195, 473, 23, 494, 228, 405, 499, 268, 104, 0, 6, 406, 460, 361, 63, 35, 404, 418, 323, 461, 19, 393, 230, 227, 171, 369, 445, 90, 136, 1, 45, 260, 79, 380, 383, 204, 455, 250, 94, 196, 427, 38, 255, 468, 166, 30, 450, 298, 371, 429, 266, 497, 496, 247, 299, 25, 108, 462, 105, 483, 293, 165, 225, 337, 292, 452, 295, 351, 16, 156, 491, 86, 362, 177, 197, 375, 181, 80, 96, 271, 221, 40, 174, 278, 236, 284, 81, 211, 99, 245, 22, 216, 395, 102, 251, 400, 118, 421, 191, 146, 78, 112, 348, 419, 464, 128, 498, 29, 282, 62, 116, 127, 478, 369, 425, 403, 256, 101, 215, 330, 53, 139, 162, 325, 206, 405, 410, 296, 246, 277, 58, 318, 418, 488, 188, 372, 225, 166, 299, 462, 196, 455, 215, 120, 383, 36, 98, 444, 496, 211, 256, 62, 293, 292, 4, 263, 128, 250, 434, 181, 40, 165, 277, 156, 491, 38, 177, 168, 255, 25, 99, 429, 197, 351, 479, 78, 395, 188, 102, 375, 112, 54, 452, 419, 69, 5, 271, 421, 425, 161, 53, 246, 86, 357, 410, 97, 162, 458, 23, 81, 418, 494, 206, 447, 436, 400, 139, 17, 204, 101, 105, 127, 498, 265, 77, 132, 96, 427, 377, 247, 254, 295, 289, 397, 478, 108, 497, 440, 403, 174, 113, 488, 195, 116, 266, 299, 40, 30, 337, 204, 250, 196, 94, 98, 97, 434, 166, 266, 120, 128, 165, 450, 36, 496, 498, 215, 156, 442, 452, 292, 108, 298, 263, 375, 395, 81, 325, 246, 255, 497, 444, 464, 293, 418, 188, 494, 23, 53, 162, 338, 38, 410, 447, 22, 195, 78, 277, 168, 99, 25, 353, 112, 247, 127, 236, 278, 216, 245, 4, 102, 80, 191, 86, 221, 314, 419, 425, 118, 478, 383, 421, 479, 300, 177, 54, 206, 197, 251, 132, 281, 458, 17, 77, 377, 205, 397, 357, 265, 289, 192, 468, 1, 499, 72, 161, 225, 299, 337, 166, 62, 372, 455, 442, 36, 196, 215, 338, 94, 462, 300, 120, 40, 98, 434, 452, 444, 263, 204, 383, 496, 81, 277, 250, 4, 256, 197, 498, 181, 177, 168, 211, 188, 102, 99, 491, 246, 53, 479, 418, 54, 410, 23, 5, 494, 292, 162, 458, 161, 78, 447, 425, 195, 112, 419, 206, 69, 17, 77, 165, 357, 128, 265, 132, 377, 289, 127, 351, 395, 397, 478, 497, 400, 298, 271, 116, 113, 247, 156, 38, 353, 25, 29, 488, 139, 101, 293, 6, 95, 281, 403, 356, 97, 375, 234, 390, 36, 38, 97, 455, 414, 427, 351, 400, 295, 251, 483, 81, 425, 4, 105, 127, 78, 156, 112, 330, 395, 146, 371, 96, 348, 325, 174, 478, 419, 281, 277, 188, 192, 246, 464, 205, 162, 353, 421, 93, 410, 53, 256, 195, 452, 494, 177, 314, 23, 498, 12, 447, 497, 247, 418, 108, 383, 362, 450, 440, 488, 22, 266, 132, 221, 216, 499, 397, 233, 481, 48, 19, 63, 323, 473, 268, 228, 1, 361, 460, 122, 406, 273, 171, 404, 104, 65, 260, 301, 17, 408, 142, 237, 136, 485, 390, 39, 446, 409, 232, 337, 372, 98, 255, 250, 462, 325, 211, 181, 491, 429, 263, 479, 25, 99, 281, 383, 192, 156, 277, 293, 12, 271, 93, 464, 206, 425, 251, 4, 295, 132, 17, 78, 127, 498, 81, 122, 330, 397, 246, 112, 440, 15, 351, 38, 265, 289, 494, 77, 369, 357, 419, 162, 23, 418, 478, 113, 69, 195, 447, 410, 452, 188, 5, 483, 247, 54, 53, 458, 400, 161, 377, 177, 282, 233, 128, 454, 348, 1, 499, 301, 323, 481, 87, 473, 441, 19, 48, 446, 268, 485, 406, 52, 437, 380, 130, 79, 260, 378, 409, 94, 225, 462, 372, 30, 256, 442, 36, 215, 338, 299, 98, 429, 414, 337, 247, 496, 383, 40, 444, 211, 455, 120, 427, 483, 300, 282, 177, 102, 250, 168, 255, 69, 330, 251, 292, 371, 479, 348, 38, 128, 196, 97, 295, 86, 375, 263, 181, 205, 452, 62, 400, 105, 81, 156, 325, 271, 434, 491, 161, 5, 497, 96, 277, 25, 188, 293, 314, 174, 281, 246, 351, 357, 54, 410, 458, 418, 395, 494, 53, 23, 162, 165, 12, 17, 204, 192, 369, 233, 93, 447, 454, 146, 440, 498, 197, 289, 77, 265, 101, 128, 98, 247, 293, 371, 383, 429, 69, 468, 282, 16, 277, 62, 54, 25, 161, 458, 5, 421, 284, 255, 479, 377, 299, 338, 292, 251, 77, 17, 265, 289, 497, 245, 298, 263, 395, 491, 236, 22, 397, 221, 118, 113, 351, 357, 29, 444, 80, 36, 254, 132, 216, 116, 278, 425, 452, 112, 191, 99, 419, 78, 146, 348, 127, 478, 120, 233, 488, 400, 105, 496, 454, 464, 330, 362, 271, 96, 181, 101, 499, 174, 445, 65, 390, 294, 273, 1, 104, 228, 252, 45, 39, 230, 81, 63, 406, 152, 171, 114, 19, 196, 372, 442, 62, 338, 255, 81, 427, 177, 383, 414, 251, 165, 211, 282, 444, 86, 292, 371, 400, 128, 263, 120, 298, 25, 498, 468, 188, 375, 295, 197, 434, 395, 105, 69, 271, 479, 181, 246, 348, 330, 53, 410, 491, 418, 97, 494, 23, 162, 293, 277, 447, 16, 156, 351, 96, 168, 325, 174, 195, 5, 450, 161, 54, 116, 99, 146, 266, 458, 281, 29, 362, 464, 205, 488, 206, 17, 93, 12, 314, 236, 233, 192, 108, 369, 221, 78, 278, 101, 80, 77, 357, 122, 454, 216, 265, 377, 397, 289, 284, 372, 166, 383, 256, 442, 215, 30, 211, 455, 36, 300, 429, 400, 348, 247, 69, 102, 81, 452, 330, 94, 263, 338, 295, 105, 188, 483, 177, 225, 282, 96, 251, 271, 5, 146, 479, 174, 161, 101, 410, 197, 53, 414, 444, 181, 23, 454, 418, 488, 233, 246, 494, 458, 168, 54, 162, 205, 491, 447, 29, 362, 86, 116, 371, 195, 196, 357, 496, 289, 17, 351, 265, 77, 397, 395, 113, 277, 139, 377, 132, 206, 254, 497, 12, 299, 93, 498, 281, 6, 192, 440, 445, 16, 337, 459, 273, 406, 63, 0, 380, 372, 225, 94, 383, 36, 496, 337, 81, 400, 429, 263, 455, 211, 452, 188, 444, 434, 181, 247, 165, 338, 250, 251, 491, 395, 410, 53, 271, 348, 246, 23, 418, 494, 292, 483, 162, 86, 102, 447, 105, 195, 351, 498, 204, 295, 62, 40, 96, 177, 101, 174, 197, 488, 25, 146, 206, 255, 330, 99, 497, 414, 69, 128, 120, 4, 293, 205, 233, 277, 254, 139, 454, 371, 5, 78, 425, 98, 357, 436, 362, 29, 116, 419, 112, 38, 95, 265, 479, 403, 54, 17, 6, 397, 161, 356, 77, 93, 289, 281, 234, 462, 256, 414, 483, 300, 86, 247, 38, 255, 293, 196, 211, 337, 496, 215, 383, 250, 165, 30, 177, 98, 251, 338, 156, 292, 375, 330, 36, 102, 348, 25, 455, 444, 282, 108, 295, 105, 69, 97, 299, 468, 400, 395, 168, 325, 181, 491, 96, 450, 40, 221, 351, 120, 174, 205, 271, 436, 236, 421, 80, 146, 266, 278, 464, 454, 233, 479, 440, 4, 16, 254, 118, 216, 139, 245, 497, 101, 357, 403, 369, 263, 22, 281, 318, 362, 284, 161, 12, 356, 277, 192, 188, 234, 191, 5, 58, 410, 93, 54, 17, 30, 225, 120, 40, 36, 166, 337, 444, 98, 215, 62, 94, 496, 372, 442, 434, 97, 168, 292, 255, 99, 491, 277, 479, 181, 256, 211, 250, 314, 263, 4, 325, 425, 25, 353, 281, 455, 462, 206, 192, 414, 156, 127, 271, 132, 93, 12, 17, 205, 478, 54, 397, 78, 5, 265, 458, 77, 289, 293, 295, 161, 112, 464, 113, 452, 122, 419, 377, 15, 498, 440, 351, 357, 81, 383, 69, 116, 481, 38, 48, 301, 323, 499, 19, 142, 232, 185, 409, 1, 268, 441, 87, 65, 408, 446, 473, 349, 390, 406, 260, 299, 337, 98, 372, 338, 36, 442, 40, 256, 62, 215, 462, 120, 455, 496, 250, 300, 444, 196, 383, 247, 204, 102, 177, 168, 128, 414, 292, 452, 211, 434, 97, 156, 479, 263, 282, 429, 38, 375, 277, 255, 69, 498, 81, 165, 181, 188, 246, 497, 161, 54, 418, 5, 197, 4, 410, 53, 494, 23, 298, 458, 162, 293, 357, 395, 483, 427, 447, 86, 25, 78, 251, 325, 17, 112, 99, 491, 205, 419, 351, 314, 77, 281, 289, 265, 132, 377, 397, 369, 353, 348, 195, 271, 116, 192, 464, 12, 236, 400, 425, 156, 211, 36, 17, 196, 77, 377, 289, 263, 265, 442, 120, 38, 4, 397, 357, 132, 113, 427, 483, 298, 62, 81, 429, 6, 284, 403, 234, 440, 188, 436, 318, 450, 266, 356, 418, 58, 498, 53, 410, 108, 296, 488, 246, 23, 494, 205, 281, 139, 95, 371, 195, 162, 395, 233, 12, 15, 454, 362, 421, 101, 447, 250, 445, 254, 122, 185, 192, 273, 93, 142, 409, 441, 406, 414, 369, 294, 19, 252, 408, 7, 232, 301, 390, 178, 72, 499, 325, 1, 65, 33, 228, 314, 48, 134, 140, 70, 473, 380, 125, 372, 247, 299, 102, 400, 128, 337, 395, 251, 496, 36, 410, 53, 497, 195, 23, 418, 246, 494, 455, 483, 250, 162, 447, 498, 69, 197, 62, 434, 177, 348, 371, 254, 436, 271, 5, 116, 29, 330, 161, 233, 146, 105, 282, 454, 40, 16, 54, 96, 205, 458, 174, 375, 206, 479, 421, 414, 295, 403, 181, 6, 318, 491, 234, 296, 95, 58, 356, 168, 139, 362, 77, 265, 289, 277, 17, 273, 228, 230, 114, 83, 377, 406, 460, 45, 19, 331, 70, 473, 57, 49, 0, 104, 252, 294, 461, 50, 231, 276, 499, 255, 211, 292, 427, 62, 434, 38, 455, 282, 247, 177, 25, 491, 330, 293, 314, 181, 205, 383, 277, 69, 271, 99, 251, 4, 17, 353, 263, 5, 161, 132, 54, 122, 458, 371, 348, 15, 397, 265, 351, 289, 77, 206, 425, 128, 102, 357, 113, 369, 377, 105, 233, 127, 146, 454, 78, 300, 96, 112, 362, 174, 400, 497, 419, 478, 116, 29, 421, 499, 473, 1, 481, 301, 185, 441, 323, 268, 19, 48, 87, 81, 260, 446, 406, 380, 409, 232, 7, 437, 273, 65, 485, 130, 136, 461, 252, 445, 142, 125, 79, 300, 165, 204, 250, 266, 86, 442, 450, 108, 30, 62, 38, 293, 299, 395, 400, 455, 81, 25, 371, 436, 225, 251, 427, 128, 188, 496, 462, 429, 452, 292, 483, 263, 53, 255, 491, 351, 215, 410, 195, 247, 197, 296, 498, 403, 23, 497, 421, 246, 162, 58, 337, 418, 95, 102, 181, 447, 22, 494, 318, 234, 4, 356, 221, 245, 284, 278, 80, 99, 139, 254, 177, 118, 236, 6, 216, 488, 298, 468, 191, 271, 434, 127, 146, 101, 78, 174, 105, 112, 425, 478, 419, 96, 206, 16, 94, 348, 383, 375, 43, 225, 299, 337, 166, 62, 372, 455, 442, 36, 196, 215, 338, 94, 462, 300, 120, 40, 98, 434, 452, 444, 263, 204, 383, 496, 81, 277, 250, 4, 256, 197, 498, 181, 177, 168, 211, 188, 102, 99, 491, 246, 53, 479, 418, 54, 410, 23, 5, 494, 292, 162, 458, 161, 78, 447, 425, 195, 112, 419, 206, 69, 17, 77, 165, 357, 128, 265, 132, 377, 289, 127, 351, 395, 397, 478, 497, 400, 298, 271, 116, 113, 247, 156, 38, 353, 25, 29, 488, 139, 101, 293, 6, 95, 281, 403, 356, 97, 375, 234, 390, 40, 98, 30, 166, 62, 250, 496, 337, 215, 36, 442, 292, 97, 120, 196, 338, 444, 300, 25, 38, 414, 427, 429, 434, 293, 204, 372, 156, 450, 325, 181, 247, 266, 491, 251, 298, 99, 464, 483, 108, 497, 498, 351, 455, 81, 78, 395, 221, 314, 112, 236, 271, 80, 278, 128, 452, 22, 127, 211, 246, 216, 462, 371, 425, 263, 419, 162, 256, 245, 281, 494, 468, 353, 447, 206, 418, 410, 165, 191, 23, 53, 188, 118, 192, 295, 375, 369, 400, 205, 478, 421, 177, 93, 277, 12, 122, 174, 195, 168, 96, 94, 427, 455, 250, 38, 255, 468, 166, 204, 298, 450, 40, 156, 300, 338, 282, 225, 266, 247, 299, 97, 375, 371, 120, 337, 496, 108, 497, 256, 30, 25, 325, 414, 292, 429, 483, 177, 293, 36, 16, 464, 295, 105, 62, 369, 479, 236, 221, 80, 15, 278, 216, 245, 277, 362, 22, 122, 444, 351, 284, 191, 118, 112, 99, 78, 314, 330, 281, 54, 491, 419, 127, 96, 174, 161, 102, 181, 197, 211, 478, 458, 93, 116, 168, 271, 12, 192, 29, 5, 425, 357, 17, 377, 185, 440, 405, 484, 232, 409, 146, 225, 94, 98, 30, 40, 496, 250, 215, 442, 36, 429, 300, 62, 196, 462, 337, 427, 414, 372, 292, 483, 38, 444, 338, 251, 97, 25, 204, 371, 256, 120, 293, 455, 434, 497, 81, 211, 491, 400, 181, 325, 452, 330, 295, 271, 165, 177, 86, 156, 395, 348, 128, 351, 464, 450, 105, 263, 298, 498, 468, 99, 102, 108, 188, 246, 383, 205, 266, 314, 410, 174, 162, 221, 96, 53, 494, 418, 23, 281, 236, 447, 375, 216, 146, 278, 80, 22, 282, 206, 192, 195, 118, 93, 245, 12, 78, 191, 122, 353, 369, 225, 427, 256, 338, 30, 455, 414, 250, 247, 337, 40, 429, 282, 38, 255, 299, 36, 300, 156, 120, 496, 372, 462, 371, 375, 483, 97, 468, 177, 204, 292, 298, 444, 325, 102, 211, 479, 215, 497, 168, 293, 450, 25, 62, 128, 295, 330, 105, 69, 369, 108, 464, 16, 277, 266, 236, 221, 348, 80, 251, 314, 278, 442, 161, 181, 351, 54, 96, 281, 357, 15, 5, 458, 174, 122, 86, 78, 12, 112, 192, 93, 362, 271, 491, 452, 17, 216, 419, 196, 197, 245, 205, 440, 22, 118, 116, 284, 191, 29, 99, 94, 225, 462, 372, 30, 256, 442, 36, 215, 338, 299, 98, 429, 414, 337, 247, 496, 383, 40, 444, 211, 455, 120, 427, 483, 300, 282, 177, 102, 250, 168, 255, 69, 330, 251, 292, 371, 479, 348, 38, 128, 196, 97, 295, 86, 375, 263, 181, 205, 452, 62, 400, 105, 81, 156, 325, 271, 434, 491, 161, 5, 497, 96, 277, 25, 188, 293, 314, 174, 281, 246, 351, 357, 54, 410, 458, 418, 395, 494, 53, 23, 162, 165, 12, 17, 204, 192, 369, 233, 93, 447, 454, 146, 440, 498, 197, 289, 77, 265, 101, 98, 94, 337, 250, 62, 165, 462, 452, 81, 247, 215, 102, 442, 372, 266, 496, 38, 177, 497, 36, 86, 40, 263, 450, 498, 128, 383, 298, 188, 395, 53, 400, 410, 246, 418, 434, 256, 23, 108, 494, 162, 375, 277, 447, 25, 293, 195, 4, 292, 16, 181, 211, 99, 491, 255, 251, 351, 468, 483, 156, 54, 78, 429, 112, 116, 419, 488, 403, 5, 425, 161, 271, 29, 95, 139, 458, 127, 296, 6, 478, 101, 234, 206, 356, 318, 69, 284, 436, 444, 427, 58, 105, 377, 96, 174, 236, 278, 77, 80, 357, 429, 211, 271, 483, 414, 462, 375, 325, 371, 464, 295, 421, 206, 298, 22, 251, 221, 216, 245, 236, 168, 80, 128, 440, 281, 263, 105, 403, 278, 191, 256, 192, 353, 132, 118, 468, 356, 96, 174, 146, 95, 204, 314, 17, 93, 397, 12, 165, 318, 234, 197, 436, 6, 296, 265, 400, 377, 205, 357, 479, 113, 395, 77, 247, 499, 139, 497, 362, 481, 330, 58, 122, 1, 48, 289, 65, 19, 390, 171, 63, 361, 237, 54, 39, 104, 268, 408, 406, 323, 142, 260, 228, 485, 473, 136, 150, 157, 409, 404, 441]

        preds2 = exp.recommend(users = [1, 2], exclude_known=False)
        assert preds2['user'].unique().tolist() == [1,2]

        preds = exp.recommend(exclude_known=True)
        joined_preds = preds.join(
            data.set_index(['user', 'item']),
            on=['user','item'], how='inner'
        )
        assert len(joined_preds) == 0
