import alpenglow as prs
from alpenglow.offline.models import FactorModel
import alpenglow.Getter as rs
import pandas as pd
import numpy as np
import unittest


class TestFactorModel(unittest.TestCase):
    def test_rmse(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        model = FactorModel(
            negative_rate=9,
            number_of_iterations=20,
        )
        model.fit(data)

        def predict(model, user, item):
            rd = rs.RecDat()
            rd.user = user
            rd.item = item
            return model.prediction(rd)

        errors = [(1 - predict(model.model, u, i))**2 for (u, i) in data[['user', 'item']].values]
        rmse = np.sqrt(pd.Series(errors)).mean()
        self.assertAlmostEqual(0.2957610395782218, rmse)

    def test_ranking(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        exp = FactorModel(
            negative_rate=9,
            number_of_iterations=20,
        )
        exp.fit(data)
        preds = exp.recommend()

        assert preds['item'].tolist() ==  \
            [94, 225, 166, 30, 299, 300, 442, 372, 337, 196, 455, 462, 250, 62, 496, 247, 338, 429, 427, 36, 255, 293, 215, 38, 40, 204, 128, 256, 177, 444, 165, 292, 383, 156, 371, 25, 120, 102, 86, 375, 211, 483, 251, 282, 491, 414, 497, 97, 468, 450, 108, 181, 277, 266, 434, 69, 263, 81, 452, 4, 271, 168, 479, 298, 99, 400, 54, 351, 5, 161, 295, 197, 16, 330, 458, 421, 395, 325, 464, 105, 348, 425, 17, 22, 216, 118, 77, 146, 265, 127, 245, 377, 236, 174, 221, 397, 116, 206, 289, 80, 197, 16, 299, 116, 204, 29, 300, 468, 97, 40, 165, 452, 281, 86, 12, 440, 205, 192, 215, 93, 497, 429, 325, 314, 99, 15, 353, 425, 464, 78, 112, 414, 295, 434, 427, 419, 445, 122, 421, 142, 284, 178, 127, 206, 233, 454, 266, 478, 380, 65, 390, 273, 185, 232, 294, 136, 48, 301, 446, 323, 134, 270, 0, 260, 406, 409, 369, 19, 474, 254, 1, 407, 72, 473, 6, 111, 441, 349, 268, 276, 33, 130, 237, 437, 39, 7, 362, 152, 290, 408, 104, 319, 302, 145, 70, 252, 485, 45, 499, 144, 293, 38, 166, 247, 225, 299, 177, 250, 30, 196, 25, 292, 491, 483, 181, 251, 351, 36, 215, 271, 330, 442, 348, 282, 444, 108, 211, 337, 414, 146, 204, 96, 128, 174, 450, 266, 256, 86, 16, 102, 156, 62, 99, 400, 69, 277, 298, 284, 375, 81, 165, 425, 233, 454, 127, 4, 478, 216, 54, 221, 118, 161, 22, 112, 78, 5, 197, 421, 40, 245, 236, 29, 206, 116, 419, 278, 80, 383, 191, 458, 397, 17, 97, 377, 122, 265, 228, 446, 113, 15, 270, 452, 473, 205, 323, 408, 268, 65, 1, 77, 30, 225, 166, 94, 299, 337, 300, 372, 98, 196, 462, 215, 250, 40, 36, 62, 496, 338, 256, 120, 455, 204, 444, 429, 38, 255, 211, 156, 293, 165, 434, 427, 292, 97, 383, 247, 128, 483, 263, 25, 168, 375, 86, 177, 102, 4, 414, 81, 251, 491, 450, 181, 452, 266, 108, 497, 99, 400, 325, 440, 197, 479, 277, 395, 271, 464, 188, 421, 295, 298, 371, 425, 206, 436, 246, 498, 351, 195, 281, 494, 69, 162, 418, 53, 127, 410, 192, 23, 54, 447, 5, 205, 93, 95, 353, 403, 314, 17, 58, 318, 30, 166, 225, 94, 300, 442, 299, 98, 337, 372, 462, 250, 204, 455, 215, 62, 256, 496, 165, 36, 429, 427, 40, 247, 38, 338, 86, 128, 255, 293, 483, 383, 102, 156, 177, 211, 375, 444, 251, 120, 450, 371, 266, 25, 292, 108, 81, 452, 263, 497, 434, 168, 97, 197, 4, 400, 414, 491, 282, 468, 69, 395, 181, 271, 277, 440, 421, 479, 298, 325, 436, 99, 464, 295, 188, 330, 54, 16, 5, 403, 195, 58, 95, 161, 318, 356, 6, 118, 296, 22, 351, 216, 234, 245, 458, 425, 498, 246, 206, 146, 225, 30, 166, 204, 196, 337, 462, 372, 299, 247, 98, 62, 102, 256, 455, 250, 452, 429, 375, 215, 497, 427, 40, 177, 496, 38, 263, 81, 251, 36, 266, 282, 156, 450, 468, 197, 108, 483, 211, 395, 371, 338, 69, 188, 400, 255, 168, 16, 434, 195, 54, 5, 161, 498, 277, 418, 53, 246, 298, 410, 479, 494, 458, 23, 162, 116, 447, 4, 25, 29, 118, 58, 245, 22, 216, 284, 403, 6, 318, 95, 356, 488, 296, 234, 191, 464, 440, 292, 377, 77, 97, 17, 325, 289, 120, 236, 265, 80, 278, 221, 30, 166, 94, 225, 442, 372, 204, 299, 337, 455, 256, 98, 250, 86, 215, 247, 102, 383, 429, 128, 36, 427, 62, 177, 496, 38, 483, 211, 452, 81, 40, 375, 338, 251, 197, 255, 497, 263, 293, 156, 400, 266, 371, 168, 450, 108, 282, 188, 434, 69, 395, 444, 4, 436, 25, 292, 440, 16, 468, 418, 498, 246, 53, 494, 195, 410, 58, 403, 162, 414, 23, 95, 6, 356, 447, 318, 120, 296, 298, 234, 479, 330, 491, 277, 5, 271, 54, 181, 139, 161, 348, 421, 116, 295, 458, 488, 29, 105, 351, 146, 225, 166, 94, 442, 300, 98, 337, 372, 196, 215, 250, 462, 496, 40, 62, 36, 338, 455, 429, 204, 255, 256, 444, 120, 293, 38, 247, 427, 292, 165, 128, 434, 383, 211, 156, 97, 25, 483, 414, 251, 263, 86, 177, 81, 102, 181, 491, 452, 497, 375, 400, 450, 168, 395, 371, 108, 99, 4, 266, 271, 325, 188, 298, 277, 351, 464, 498, 479, 295, 246, 494, 421, 162, 418, 197, 53, 410, 23, 447, 195, 282, 69, 440, 425, 206, 330, 468, 78, 127, 112, 348, 205, 5, 281, 105, 80, 54, 236, 22, 278, 166, 442, 337, 300, 372, 196, 215, 496, 36, 462, 250, 338, 128, 383, 247, 165, 120, 256, 434, 429, 444, 263, 293, 255, 292, 455, 452, 497, 86, 97, 395, 102, 251, 38, 414, 156, 188, 25, 375, 211, 246, 494, 162, 418, 410, 53, 427, 168, 23, 400, 447, 181, 298, 277, 479, 195, 325, 450, 99, 282, 483, 491, 464, 421, 69, 5, 266, 54, 161, 108, 4, 80, 236, 278, 468, 221, 458, 271, 78, 206, 197, 112, 357, 371, 351, 22, 118, 17, 419, 77, 314, 216, 353, 205, 425, 245, 116, 265, 281, 289, 166, 30, 94, 225, 462, 455, 337, 300, 442, 98, 102, 196, 177, 247, 128, 36, 204, 299, 282, 168, 69, 165, 211, 215, 375, 62, 86, 120, 277, 479, 5, 161, 197, 452, 54, 263, 444, 458, 156, 38, 4, 250, 293, 429, 16, 81, 40, 496, 427, 77, 17, 497, 289, 377, 265, 434, 116, 397, 29, 113, 132, 483, 357, 188, 400, 255, 440, 436, 251, 468, 491, 99, 6, 266, 418, 195, 58, 403, 205, 271, 330, 246, 181, 494, 450, 53, 95, 356, 162, 498, 318, 234, 108, 23, 296, 488, 410, 295, 425, 454, 94, 166, 225, 442, 98, 462, 337, 196, 256, 215, 250, 36, 204, 338, 247, 496, 427, 429, 38, 177, 62, 383, 102, 165, 255, 40, 211, 293, 128, 444, 86, 483, 292, 120, 156, 375, 181, 452, 81, 251, 282, 25, 371, 168, 491, 263, 197, 434, 4, 414, 69, 497, 277, 351, 400, 450, 108, 266, 271, 348, 105, 188, 479, 99, 295, 5, 330, 298, 54, 97, 395, 161, 494, 418, 16, 246, 174, 468, 96, 498, 162, 53, 410, 23, 458, 447, 78, 112, 440, 139, 436, 357, 425, 419, 146, 116, 17, 421, 403, 77, 30, 225, 94, 299, 372, 204, 337, 215, 250, 165, 36, 256, 98, 496, 86, 455, 383, 40, 247, 62, 429, 102, 452, 81, 128, 483, 211, 263, 251, 427, 38, 188, 497, 434, 338, 177, 255, 197, 498, 246, 418, 444, 494, 410, 53, 292, 375, 23, 162, 293, 414, 447, 168, 156, 195, 181, 450, 120, 440, 266, 25, 371, 298, 436, 108, 271, 139, 4, 348, 491, 95, 58, 403, 6, 356, 330, 296, 318, 69, 351, 97, 234, 105, 488, 101, 421, 174, 295, 96, 479, 282, 99, 206, 146, 325, 205, 464, 116, 236, 278, 166, 94, 40, 98, 300, 496, 372, 215, 250, 36, 338, 120, 462, 444, 204, 292, 255, 434, 293, 97, 429, 128, 165, 156, 256, 38, 263, 383, 414, 25, 247, 455, 395, 211, 427, 181, 375, 497, 251, 450, 325, 86, 168, 188, 298, 81, 452, 464, 491, 99, 483, 498, 266, 4, 246, 108, 162, 494, 53, 418, 410, 102, 421, 23, 447, 400, 277, 479, 80, 278, 236, 221, 78, 112, 195, 351, 271, 177, 206, 22, 419, 425, 216, 118, 440, 245, 127, 357, 281, 191, 314, 353, 192, 371, 12, 93, 132, 17, 197, 54, 414, 53, 292, 181, 246, 447, 494, 139, 96, 162, 78, 188, 410, 351, 278, 498, 236, 174, 101, 23, 357, 348, 221, 80, 419, 418, 395, 369, 105, 112, 298, 94, 166, 30, 225, 442, 299, 196, 372, 462, 98, 455, 337, 250, 204, 215, 427, 429, 247, 496, 256, 165, 36, 38, 62, 86, 255, 177, 293, 40, 102, 338, 128, 483, 383, 211, 371, 251, 81, 156, 444, 452, 25, 375, 292, 497, 450, 108, 400, 266, 491, 263, 197, 434, 181, 120, 282, 271, 4, 468, 414, 168, 69, 330, 295, 351, 277, 395, 99, 16, 97, 188, 436, 298, 348, 105, 421, 440, 146, 195, 479, 54, 403, 58, 5, 95, 318, 356, 6, 296, 494, 418, 246, 498, 161, 53, 234, 174, 425, 162, 410, 166, 225, 94, 442, 299, 300, 337, 372, 98, 196, 462, 250, 215, 36, 455, 62, 256, 496, 204, 40, 338, 429, 247, 165, 38, 427, 128, 383, 255, 444, 120, 293, 211, 102, 156, 86, 177, 483, 375, 292, 434, 263, 168, 251, 414, 81, 97, 452, 25, 497, 4, 450, 266, 181, 197, 371, 491, 108, 400, 282, 479, 395, 277, 69, 188, 298, 271, 99, 440, 325, 295, 5, 54, 351, 498, 246, 464, 494, 421, 418, 161, 162, 53, 410, 330, 468, 23, 458, 447, 436, 195, 348, 17, 77, 205, 16, 425, 206, 281, 105, 94, 102, 225, 30, 462, 455, 165, 86, 372, 196, 177, 337, 375, 69, 452, 497, 468, 161, 429, 5, 54, 442, 16, 62, 458, 197, 427, 371, 479, 168, 251, 299, 277, 81, 263, 38, 116, 250, 293, 29, 188, 338, 483, 211, 395, 156, 36, 266, 418, 400, 377, 498, 298, 77, 289, 17, 53, 410, 23, 494, 246, 162, 265, 108, 215, 450, 284, 447, 357, 195, 397, 113, 348, 330, 233, 454, 236, 436, 4, 421, 132, 105, 118, 80, 488, 101, 221, 278, 254, 245, 414, 216, 255, 174, 362, 22, 6, 58, 496, 96, 94, 30, 166, 225, 300, 442, 299, 337, 372, 462, 455, 250, 247, 62, 256, 165, 429, 215, 128, 427, 496, 36, 86, 38, 40, 383, 102, 293, 338, 255, 177, 375, 483, 156, 211, 371, 251, 497, 452, 292, 444, 450, 266, 282, 25, 81, 108, 263, 414, 468, 120, 168, 197, 400, 69, 434, 395, 97, 298, 4, 277, 491, 479, 181, 16, 188, 54, 5, 421, 161, 271, 325, 464, 330, 458, 498, 295, 418, 246, 494, 53, 351, 162, 436, 118, 348, 410, 195, 99, 22, 23, 216, 440, 236, 447, 245, 116, 105, 80, 221, 166, 442, 196, 337, 372, 462, 215, 496, 429, 40, 247, 427, 255, 165, 38, 293, 128, 338, 86, 292, 256, 483, 251, 383, 371, 25, 102, 177, 444, 497, 414, 156, 81, 211, 434, 181, 395, 108, 120, 266, 400, 375, 263, 491, 97, 468, 188, 351, 498, 271, 246, 494, 418, 162, 53, 410, 105, 447, 23, 348, 99, 197, 421, 282, 221, 236, 278, 295, 80, 174, 4, 325, 464, 330, 96, 195, 277, 168, 78, 112, 69, 118, 22, 216, 16, 245, 419, 425, 146, 206, 191, 479, 127, 436, 139, 54, 101, 440, 5, 205, 442, 300, 196, 250, 372, 38, 429, 496, 62, 255, 293, 40, 462, 338, 36, 215, 292, 156, 256, 204, 247, 483, 414, 371, 444, 25, 177, 375, 128, 120, 450, 165, 97, 266, 108, 211, 86, 181, 251, 102, 468, 491, 351, 4, 325, 221, 236, 395, 80, 278, 168, 497, 464, 282, 434, 348, 105, 383, 421, 277, 295, 271, 174, 78, 112, 99, 96, 197, 22, 216, 118, 245, 419, 479, 69, 330, 81, 357, 440, 139, 191, 263, 400, 425, 16, 162, 54, 369, 127, 494, 498, 246, 418, 53, 188, 161, 5, 452, 146, 447, 215, 284, 455, 102, 16, 282, 436, 177, 400, 12, 281, 440, 314, 122, 498, 36, 192, 295, 15, 162, 174, 318, 195, 120, 58, 254, 93, 403, 447, 53, 1, 369, 146, 410, 499, 290, 127, 434, 362, 353, 246, 296, 351, 256, 361, 491, 81, 104, 494, 425, 356, 90, 230, 444, 95, 19, 474, 52, 79, 418, 50, 268, 485, 232, 227, 237, 48, 493, 473, 35, 136, 484, 164, 129, 59, 336, 228, 388, 150, 409, 270, 171, 23, 234, 134, 446, 305, 186, 407, 349, 185, 111, 390, 381, 157, 294, 105, 445, 78, 311, 225, 166, 299, 442, 300, 98, 196, 337, 250, 372, 215, 496, 62, 462, 40, 204, 36, 429, 455, 247, 427, 293, 338, 38, 128, 292, 256, 86, 444, 25, 251, 383, 483, 434, 120, 156, 211, 371, 97, 497, 414, 263, 102, 452, 177, 450, 400, 491, 108, 375, 266, 395, 181, 271, 99, 468, 298, 325, 464, 188, 421, 4, 295, 351, 195, 168, 498, 277, 197, 246, 22, 494, 118, 216, 162, 282, 418, 330, 53, 410, 245, 447, 23, 206, 425, 191, 479, 69, 80, 221, 236, 278, 127, 348, 105, 146, 440, 205, 436, 16, 429, 98, 256, 488, 116, 206, 197, 421, 29, 298, 254, 338, 101, 353, 211, 271, 292, 205, 5, 314, 118, 99, 69, 22, 16, 255, 191, 54, 468, 216, 436, 161, 245, 493, 83, 278, 408, 231, 228, 114, 233, 460, 361, 273, 183, 499, 35, 1, 323, 230, 464, 479, 406, 79, 302, 49, 7, 129, 80, 33, 134, 155, 25, 473, 252, 19, 186, 469, 237, 87, 268, 301, 236, 485, 459, 308, 290, 125, 171, 388, 486, 481, 404, 441, 57, 405, 227, 50, 70, 319, 311, 72, 409, 63, 378, 347, 294, 276, 52, 43, 225, 30, 299, 442, 337, 156, 38, 444, 293, 62, 496, 250, 36, 292, 372, 455, 25, 196, 429, 375, 215, 450, 483, 266, 4, 108, 168, 177, 464, 491, 371, 300, 277, 479, 99, 181, 434, 295, 128, 425, 22, 421, 468, 247, 216, 462, 245, 127, 298, 132, 440, 281, 118, 271, 351, 17, 191, 192, 397, 12, 265, 77, 80, 478, 69, 54, 221, 236, 205, 278, 289, 113, 161, 78, 112, 251, 353, 93, 377, 458, 5, 419, 357, 206, 146, 16, 197, 499, 233, 454, 284, 445, 48, 19, 294, 362, 142, 185, 390, 407, 30, 166, 94, 337, 300, 204, 442, 196, 98, 462, 247, 102, 256, 86, 40, 452, 338, 263, 215, 455, 497, 36, 282, 250, 375, 496, 69, 395, 81, 293, 429, 188, 177, 5, 161, 434, 277, 54, 479, 168, 120, 458, 468, 251, 498, 156, 418, 246, 53, 410, 494, 23, 162, 195, 197, 447, 16, 400, 211, 116, 444, 38, 77, 255, 17, 289, 298, 29, 377, 450, 266, 265, 421, 108, 397, 357, 97, 427, 113, 4, 292, 132, 118, 488, 22, 236, 464, 371, 80, 216, 25, 245, 325, 278, 254, 191, 206, 221, 284, 99, 300, 98, 196, 204, 38, 211, 250, 337, 165, 197, 375, 81, 255, 338, 168, 128, 452, 105, 295, 293, 16, 400, 444, 496, 5, 146, 174, 96, 161, 54, 479, 271, 351, 458, 277, 156, 491, 181, 468, 4, 497, 25, 29, 116, 6, 440, 403, 436, 292, 58, 356, 234, 95, 296, 108, 318, 266, 139, 17, 77, 377, 265, 284, 289, 263, 397, 357, 298, 362, 113, 450, 488, 101, 188, 132, 418, 15, 122, 281, 369, 494, 273, 93, 294, 246, 426, 406, 48, 445, 53, 185, 405, 200, 349, 254, 144, 186, 49, 19, 260, 166, 30, 94, 225, 462, 372, 442, 196, 299, 455, 337, 98, 204, 256, 247, 215, 165, 102, 36, 128, 250, 86, 177, 62, 429, 338, 496, 452, 211, 427, 38, 81, 40, 282, 263, 293, 497, 375, 251, 255, 483, 69, 197, 400, 444, 168, 156, 434, 371, 277, 5, 54, 120, 161, 479, 188, 16, 4, 458, 468, 25, 491, 266, 271, 195, 450, 108, 116, 330, 395, 292, 418, 498, 246, 494, 181, 53, 29, 410, 162, 23, 436, 447, 295, 77, 17, 99, 377, 348, 265, 289, 146, 488, 440, 414, 58, 6, 403, 397, 105, 225, 94, 98, 300, 196, 462, 338, 36, 215, 62, 250, 256, 496, 40, 204, 120, 444, 38, 429, 247, 255, 383, 427, 211, 177, 156, 165, 292, 102, 375, 434, 263, 168, 86, 25, 181, 483, 97, 414, 277, 491, 282, 251, 81, 452, 479, 450, 69, 497, 266, 197, 108, 99, 371, 351, 5, 271, 54, 395, 161, 400, 298, 188, 458, 295, 246, 494, 498, 78, 162, 357, 418, 112, 53, 17, 440, 325, 410, 421, 77, 23, 468, 348, 425, 105, 447, 265, 464, 419, 377, 397, 289, 206, 127, 16, 330, 132, 174, 96, 113, 225, 166, 94, 442, 300, 98, 337, 372, 196, 215, 462, 250, 496, 36, 40, 62, 338, 455, 429, 256, 204, 255, 444, 120, 38, 293, 427, 247, 292, 165, 128, 211, 383, 156, 434, 25, 97, 483, 414, 177, 263, 86, 251, 181, 102, 491, 375, 81, 168, 452, 497, 450, 4, 371, 400, 108, 266, 395, 99, 271, 277, 351, 298, 325, 188, 479, 295, 197, 464, 498, 246, 494, 282, 162, 421, 418, 69, 53, 410, 440, 23, 447, 425, 330, 78, 348, 206, 112, 195, 5, 105, 54, 127, 468, 205, 161, 236, 80, 174, 281, 94, 30, 166, 225, 442, 299, 372, 196, 462, 98, 337, 455, 250, 204, 215, 496, 36, 429, 247, 256, 427, 165, 62, 38, 40, 255, 86, 338, 128, 177, 383, 293, 102, 483, 211, 251, 444, 81, 371, 452, 156, 25, 292, 375, 497, 263, 400, 434, 450, 120, 108, 491, 266, 197, 181, 282, 414, 4, 271, 168, 69, 468, 97, 295, 330, 395, 277, 188, 99, 351, 298, 16, 436, 479, 421, 195, 348, 440, 105, 54, 5, 146, 246, 494, 498, 418, 53, 161, 162, 410, 403, 58, 23, 95, 447, 318, 425, 356, 6, 206, 30, 225, 166, 299, 94, 98, 215, 196, 250, 372, 337, 40, 36, 462, 62, 255, 429, 338, 455, 444, 427, 38, 292, 293, 204, 120, 434, 25, 483, 211, 165, 491, 97, 247, 256, 181, 251, 156, 414, 81, 400, 263, 86, 371, 271, 99, 450, 128, 177, 108, 383, 497, 452, 266, 351, 295, 395, 4, 325, 102, 188, 298, 464, 425, 421, 375, 330, 206, 127, 440, 498, 246, 494, 195, 105, 162, 168, 418, 53, 410, 348, 447, 23, 197, 146, 78, 112, 174, 277, 478, 96, 22, 281, 205, 436, 118, 216, 192, 245, 353, 166, 30, 225, 300, 462, 372, 455, 256, 98, 196, 337, 442, 247, 128, 102, 165, 383, 299, 86, 177, 375, 250, 427, 429, 62, 38, 36, 338, 215, 156, 211, 69, 483, 452, 168, 197, 293, 497, 371, 496, 251, 468, 479, 54, 5, 161, 81, 263, 40, 266, 277, 16, 458, 450, 255, 108, 4, 444, 400, 120, 116, 395, 414, 298, 188, 436, 77, 17, 29, 377, 289, 265, 330, 440, 25, 421, 58, 397, 403, 6, 418, 113, 318, 195, 95, 356, 234, 498, 53, 284, 296, 292, 246, 494, 162, 132, 348, 410, 23, 357, 30, 299, 166, 94, 442, 337, 98, 496, 300, 196, 250, 215, 36, 372, 338, 120, 255, 293, 444, 128, 434, 97, 462, 204, 292, 429, 165, 25, 156, 247, 38, 263, 383, 497, 427, 414, 251, 395, 256, 325, 450, 455, 464, 375, 491, 99, 452, 86, 211, 181, 81, 266, 108, 421, 298, 400, 483, 277, 188, 498, 168, 22, 246, 4, 216, 195, 162, 494, 479, 118, 102, 371, 245, 271, 53, 410, 418, 206, 23, 468, 447, 80, 191, 278, 236, 425, 221, 127, 314, 353, 281, 78, 112, 192, 12, 177, 351, 478, 132, 54, 30, 300, 299, 442, 196, 455, 372, 337, 38, 429, 462, 255, 496, 293, 215, 62, 36, 204, 247, 256, 40, 338, 483, 292, 156, 371, 177, 25, 165, 444, 414, 211, 450, 375, 128, 86, 108, 266, 251, 120, 181, 97, 102, 491, 298, 351, 468, 4, 497, 105, 271, 383, 348, 295, 282, 168, 434, 325, 197, 395, 81, 221, 236, 464, 330, 99, 80, 174, 278, 421, 400, 96, 277, 78, 112, 69, 216, 440, 22, 118, 245, 263, 16, 139, 425, 146, 452, 419, 436, 479, 191, 127, 403, 318, 357, 58, 54, 356, 95, 296, 94, 166, 225, 300, 442, 462, 256, 372, 337, 98, 299, 165, 86, 427, 250, 247, 102, 38, 177, 429, 375, 128, 483, 156, 383, 215, 211, 62, 36, 450, 108, 371, 197, 293, 168, 496, 338, 282, 255, 251, 40, 452, 468, 497, 69, 4, 81, 414, 436, 440, 298, 16, 58, 403, 292, 395, 479, 263, 6, 318, 95, 444, 25, 356, 234, 400, 139, 296, 54, 97, 5, 277, 161, 421, 188, 120, 330, 458, 325, 348, 464, 236, 118, 245, 80, 278, 221, 116, 284, 295, 418, 216, 22, 53, 29, 246, 498, 494, 105, 162, 166, 299, 98, 300, 462, 196, 36, 455, 215, 62, 256, 250, 40, 120, 496, 444, 38, 211, 293, 383, 156, 204, 255, 292, 128, 177, 247, 168, 434, 102, 427, 263, 181, 375, 4, 165, 277, 97, 25, 491, 479, 414, 483, 99, 69, 86, 282, 452, 81, 197, 351, 5, 54, 161, 450, 251, 271, 188, 357, 497, 458, 395, 112, 78, 298, 266, 246, 108, 494, 162, 498, 418, 440, 53, 400, 295, 17, 77, 419, 23, 410, 447, 265, 397, 425, 132, 289, 377, 325, 206, 105, 348, 127, 113, 139, 421, 174, 464, 96, 281, 196, 215, 444, 250, 177, 496, 40, 168, 62, 4, 427, 293, 255, 102, 375, 292, 181, 429, 383, 204, 434, 277, 483, 491, 197, 97, 479, 263, 440, 247, 99, 69, 25, 450, 351, 128, 165, 282, 414, 266, 108, 5, 112, 54, 78, 139, 271, 161, 295, 357, 458, 419, 425, 86, 436, 17, 77, 403, 95, 58, 6, 318, 356, 127, 132, 265, 397, 296, 81, 234, 289, 377, 348, 105, 113, 281, 478, 96, 174, 452, 206, 330, 205, 192, 93, 101, 188, 325, 246, 494, 12, 162, 418, 369, 353, 400, 16, 53, 251, 498, 483, 225, 166, 255, 298, 30, 251, 337, 497, 69, 197, 216, 118, 245, 236, 221, 22, 80, 278, 25, 191, 421, 414, 54, 383, 161, 462, 464, 372, 436, 5, 458, 325, 277, 292, 58, 4, 403, 395, 234, 318, 116, 29, 6, 168, 348, 356, 105, 296, 330, 95, 299, 139, 211, 97, 479, 362, 454, 233, 377, 174, 442, 17, 146, 96, 289, 77, 265, 351, 254, 452, 113, 357, 397, 440, 122, 1, 15, 228, 290, 295, 104, 164, 485, 186, 270, 474, 499, 227, 473, 349, 35, 268, 446, 111, 50, 484, 230, 409, 301, 338, 337, 99, 40, 256, 204, 108, 454, 233, 425, 362, 468, 206, 127, 434, 298, 497, 86, 450, 112, 266, 78, 478, 62, 205, 4, 452, 97, 120, 419, 284, 102, 282, 197, 16, 221, 156, 122, 488, 69, 356, 101, 296, 15, 216, 405, 331, 95, 49, 446, 318, 200, 228, 403, 260, 118, 155, 144, 186, 22, 288, 420, 323, 268, 57, 0, 270, 273, 481, 136, 459, 426, 165, 473, 406, 48, 19, 131, 157, 183, 45, 227, 344, 43, 150, 33, 408, 114, 404, 369, 65, 305, 35, 349, 441, 290, 70, 421, 283, 461, 94, 225, 166, 30, 299, 442, 372, 196, 337, 462, 455, 250, 215, 496, 247, 62, 204, 429, 36, 427, 255, 338, 40, 293, 256, 38, 128, 165, 383, 177, 86, 102, 444, 292, 371, 211, 483, 251, 25, 156, 497, 120, 375, 452, 81, 491, 434, 263, 282, 181, 450, 414, 108, 400, 266, 468, 271, 97, 277, 69, 197, 4, 395, 298, 351, 168, 99, 295, 330, 479, 54, 16, 5, 105, 188, 161, 348, 421, 498, 458, 494, 246, 418, 325, 162, 464, 146, 195, 53, 174, 425, 410, 23, 447, 206, 96, 116, 118, 22, 216, 225, 166, 372, 299, 462, 98, 196, 36, 215, 256, 455, 62, 250, 40, 496, 204, 120, 383, 444, 211, 128, 165, 38, 247, 102, 429, 156, 177, 293, 263, 434, 168, 255, 292, 375, 86, 427, 4, 452, 181, 81, 277, 479, 483, 197, 97, 188, 491, 25, 69, 497, 414, 282, 251, 395, 99, 246, 498, 450, 494, 5, 400, 418, 162, 53, 54, 161, 410, 23, 266, 440, 447, 351, 108, 458, 271, 298, 357, 78, 112, 77, 17, 139, 195, 419, 295, 265, 436, 377, 206, 289, 425, 397, 421, 132, 101, 325, 127, 113, 348, 30, 166, 94, 299, 442, 98, 337, 300, 196, 40, 372, 250, 496, 338, 215, 36, 462, 128, 204, 293, 247, 429, 255, 120, 165, 455, 38, 256, 156, 444, 427, 383, 292, 97, 375, 434, 86, 25, 263, 497, 102, 450, 251, 211, 414, 266, 177, 108, 483, 395, 452, 168, 371, 277, 325, 468, 464, 81, 298, 491, 479, 4, 282, 421, 99, 181, 400, 69, 54, 22, 5, 216, 161, 118, 188, 245, 498, 271, 458, 236, 80, 191, 278, 197, 195, 246, 221, 162, 494, 418, 53, 17, 425, 206, 410, 77, 23, 447, 265, 127, 166, 225, 94, 442, 299, 300, 337, 372, 98, 462, 196, 215, 250, 36, 455, 256, 62, 40, 496, 204, 338, 429, 247, 165, 38, 383, 128, 444, 120, 427, 211, 255, 102, 293, 156, 86, 177, 483, 375, 292, 434, 168, 263, 452, 251, 81, 97, 414, 25, 497, 4, 450, 197, 181, 266, 400, 491, 108, 479, 282, 277, 395, 371, 69, 188, 298, 440, 271, 99, 325, 5, 54, 498, 246, 494, 418, 162, 295, 161, 53, 464, 351, 421, 410, 23, 447, 458, 195, 436, 330, 468, 17, 77, 348, 205, 281, 206, 425, 16, 265, 36, 97, 38, 455, 351, 427, 425, 295, 400, 81, 127, 414, 251, 78, 112, 4, 277, 478, 419, 156, 105, 383, 246, 188, 494, 498, 162, 195, 96, 330, 325, 452, 174, 447, 146, 410, 353, 53, 23, 418, 497, 395, 348, 281, 192, 464, 314, 421, 205, 247, 177, 371, 93, 483, 12, 132, 450, 362, 397, 108, 298, 256, 488, 128, 122, 17, 113, 357, 265, 254, 479, 77, 15, 323, 268, 408, 104, 499, 0, 237, 65, 228, 481, 460, 485, 87, 473, 301, 232, 1, 441, 393, 136, 33, 361, 7, 276, 369, 19, 49, 337, 98, 372, 250, 196, 255, 156, 263, 462, 99, 325, 25, 181, 293, 491, 211, 4, 300, 464, 281, 38, 192, 479, 425, 277, 127, 12, 440, 206, 93, 78, 112, 429, 132, 395, 271, 419, 498, 478, 246, 162, 421, 383, 494, 188, 195, 351, 418, 53, 17, 23, 81, 410, 397, 295, 447, 77, 265, 450, 113, 357, 289, 122, 400, 15, 375, 22, 298, 377, 369, 251, 80, 191, 278, 216, 128, 245, 452, 488, 236, 266, 483, 499, 497, 221, 108, 118, 19, 481, 48, 445, 185, 294, 390, 237, 406, 361, 460, 323, 7, 30, 225, 94, 442, 299, 372, 300, 337, 462, 98, 196, 455, 256, 215, 36, 338, 250, 204, 62, 247, 496, 40, 383, 165, 128, 429, 38, 102, 177, 211, 444, 427, 120, 293, 86, 156, 255, 375, 168, 483, 263, 452, 292, 434, 81, 282, 251, 4, 197, 69, 497, 277, 479, 25, 414, 97, 450, 181, 400, 266, 491, 5, 371, 108, 54, 161, 188, 395, 458, 271, 440, 99, 298, 295, 246, 498, 418, 494, 16, 162, 351, 53, 468, 17, 77, 330, 410, 23, 436, 421, 265, 325, 377, 447, 289, 195, 348, 397, 357, 116, 429, 299, 371, 16, 215, 69, 247, 298, 98, 421, 36, 93, 97, 325, 479, 284, 281, 383, 488, 101, 282, 330, 81, 454, 464, 338, 414, 192, 233, 128, 205, 245, 452, 295, 12, 118, 122, 251, 348, 468, 254, 54, 120, 236, 481, 377, 29, 227, 7, 441, 146, 186, 499, 231, 48, 39, 406, 77, 45, 72, 144, 125, 230, 17, 228, 273, 191, 216, 22, 35, 104, 157, 459, 63, 129, 1, 460, 252, 409, 485, 426, 200, 237, 188, 445, 469, 425, 268, 294, 478, 33, 407, 388, 278, 270, 136, 260, 70, 43, 155, 442, 372, 196, 62, 165, 427, 383, 86, 255, 338, 251, 128, 177, 81, 293, 211, 292, 444, 371, 414, 400, 25, 434, 263, 181, 395, 188, 491, 375, 348, 120, 271, 197, 351, 330, 156, 105, 282, 498, 246, 494, 418, 298, 295, 410, 53, 162, 23, 69, 447, 168, 174, 450, 108, 96, 97, 266, 468, 195, 146, 277, 479, 4, 16, 99, 5, 54, 421, 205, 116, 440, 161, 221, 236, 233, 454, 325, 436, 278, 206, 139, 29, 464, 80, 101, 112, 458, 78, 488, 425, 403, 6, 58, 95, 356, 357, 296, 419, 118, 318, 166, 30, 94, 225, 300, 372, 442, 455, 337, 299, 196, 256, 98, 204, 215, 36, 383, 247, 102, 250, 165, 338, 177, 86, 211, 429, 128, 38, 496, 62, 427, 452, 483, 168, 40, 81, 375, 444, 197, 263, 282, 69, 156, 293, 120, 255, 251, 4, 400, 497, 479, 434, 277, 5, 54, 161, 371, 458, 188, 491, 16, 440, 330, 271, 266, 436, 181, 450, 108, 25, 292, 295, 6, 403, 58, 414, 116, 95, 195, 356, 418, 348, 318, 246, 296, 494, 234, 77, 53, 17, 498, 29, 162, 410, 377, 23, 99, 395, 265, 289, 225, 94, 372, 337, 36, 455, 250, 98, 204, 496, 338, 40, 383, 211, 165, 62, 429, 444, 102, 247, 120, 86, 38, 81, 177, 434, 452, 263, 483, 427, 168, 255, 292, 181, 188, 128, 400, 197, 156, 251, 4, 293, 414, 491, 246, 418, 494, 498, 375, 53, 410, 162, 440, 395, 23, 447, 351, 497, 25, 271, 139, 348, 97, 99, 69, 436, 479, 195, 295, 277, 330, 450, 105, 95, 403, 266, 6, 58, 174, 356, 101, 96, 108, 296, 318, 78, 112, 298, 234, 282, 205, 5, 206, 488, 419, 357, 54, 425, 281, 161, 30, 300, 98, 299, 196, 455, 337, 250, 462, 38, 204, 247, 256, 293, 62, 255, 165, 496, 177, 156, 215, 86, 36, 483, 338, 375, 40, 102, 292, 450, 211, 266, 108, 25, 414, 383, 251, 444, 468, 282, 298, 497, 120, 97, 181, 4, 168, 197, 491, 69, 395, 351, 81, 277, 348, 236, 105, 221, 452, 80, 16, 278, 421, 325, 464, 263, 271, 479, 400, 295, 54, 330, 174, 5, 161, 118, 96, 216, 22, 245, 434, 436, 99, 458, 440, 139, 191, 78, 357, 112, 188, 146, 284, 403, 418, 494, 162, 58, 17, 498, 30, 225, 166, 94, 442, 98, 337, 372, 36, 215, 300, 40, 62, 496, 196, 120, 444, 462, 250, 255, 455, 293, 434, 256, 292, 38, 429, 97, 211, 25, 156, 491, 383, 263, 181, 128, 427, 247, 99, 177, 204, 277, 4, 168, 271, 414, 479, 165, 81, 251, 375, 425, 102, 452, 351, 497, 450, 127, 295, 400, 483, 206, 325, 108, 5, 69, 54, 282, 161, 266, 78, 112, 464, 478, 17, 458, 132, 77, 421, 397, 265, 281, 419, 205, 353, 289, 314, 371, 195, 197, 113, 395, 377, 86, 192, 188, 246, 498, 440, 494, 442, 299, 300, 337, 372, 98, 196, 462, 455, 250, 215, 62, 36, 256, 338, 204, 40, 496, 247, 429, 128, 165, 383, 38, 120, 427, 293, 444, 102, 255, 156, 211, 177, 86, 375, 292, 483, 168, 263, 434, 414, 452, 251, 97, 25, 81, 497, 181, 4, 282, 450, 395, 277, 266, 479, 197, 69, 108, 371, 298, 188, 491, 400, 498, 246, 5, 494, 418, 54, 162, 53, 161, 351, 410, 23, 99, 271, 447, 458, 325, 468, 440, 421, 464, 357, 295, 348, 78, 112, 236, 17, 80, 105, 77, 16, 278, 195, 221, 174, 139, 196, 263, 77, 377, 289, 17, 265, 211, 156, 62, 397, 357, 113, 442, 36, 81, 132, 38, 429, 4, 188, 293, 371, 284, 427, 251, 418, 53, 23, 498, 494, 162, 410, 246, 454, 233, 195, 447, 395, 266, 436, 330, 488, 400, 483, 348, 254, 298, 205, 6, 362, 101, 58, 403, 234, 445, 108, 142, 273, 380, 178, 301, 1, 134, 294, 473, 228, 390, 120, 356, 114, 318, 409, 270, 349, 72, 15, 474, 65, 290, 232, 130, 408, 296, 185, 186, 35, 437, 319, 446, 450, 164, 406, 441, 145, 323, 252, 407, 144, 111, 372, 337, 299, 102, 247, 455, 250, 128, 36, 400, 197, 497, 418, 498, 410, 246, 53, 494, 251, 62, 177, 23, 395, 447, 162, 168, 195, 483, 496, 434, 40, 436, 69, 440, 375, 58, 6, 95, 403, 139, 356, 98, 296, 234, 318, 282, 116, 5, 29, 479, 16, 338, 54, 4, 161, 348, 330, 458, 38, 205, 254, 454, 233, 271, 266, 427, 206, 146, 174, 93, 96, 298, 77, 377, 105, 353, 277, 450, 421, 108, 281, 289, 17, 406, 231, 265, 228, 83, 444, 441, 227, 273, 186, 183, 144, 7, 252, 35, 481, 493, 62, 196, 211, 38, 4, 292, 434, 255, 300, 293, 455, 25, 263, 427, 450, 491, 277, 99, 181, 132, 314, 266, 353, 17, 177, 77, 108, 397, 205, 421, 265, 197, 289, 425, 357, 113, 298, 204, 95, 377, 127, 403, 318, 436, 271, 356, 58, 6, 54, 296, 139, 112, 206, 5, 78, 458, 234, 161, 383, 69, 22, 245, 395, 128, 102, 122, 419, 80, 351, 251, 278, 478, 15, 216, 236, 191, 118, 221, 369, 165, 81, 330, 162, 246, 488, 445, 499, 48, 185, 19, 294, 481, 406, 7, 273, 498, 237, 136, 390, 494, 30, 166, 225, 94, 442, 300, 299, 337, 372, 462, 98, 250, 204, 215, 455, 62, 256, 496, 165, 36, 40, 429, 247, 427, 38, 86, 338, 128, 255, 483, 383, 293, 102, 211, 156, 177, 375, 444, 251, 120, 81, 452, 450, 263, 266, 25, 371, 292, 497, 434, 108, 168, 97, 414, 400, 197, 4, 491, 395, 282, 440, 325, 69, 468, 271, 479, 421, 436, 464, 188, 298, 181, 277, 295, 330, 99, 195, 403, 58, 95, 54, 318, 356, 5, 6, 296, 16, 118, 22, 498, 161, 245, 246, 234, 216, 418, 494, 53, 162, 410, 166, 225, 94, 442, 299, 300, 372, 98, 337, 196, 462, 250, 215, 455, 36, 256, 62, 338, 496, 40, 204, 429, 38, 247, 427, 165, 444, 255, 120, 128, 293, 383, 211, 156, 177, 102, 483, 86, 375, 292, 168, 434, 263, 97, 25, 251, 414, 81, 452, 4, 450, 497, 266, 371, 491, 108, 181, 197, 282, 277, 479, 400, 69, 395, 271, 99, 298, 440, 325, 54, 5, 295, 188, 161, 464, 351, 421, 468, 458, 330, 246, 498, 436, 494, 418, 162, 53, 17, 77, 410, 348, 425, 16, 195, 23, 205, 265, 447, 281, 206, 30, 166, 442, 98, 300, 196, 337, 372, 250, 496, 62, 215, 40, 36, 462, 429, 455, 427, 338, 293, 38, 292, 204, 444, 247, 25, 120, 128, 256, 165, 156, 414, 371, 97, 483, 181, 434, 211, 251, 491, 177, 86, 450, 383, 108, 266, 375, 497, 351, 81, 263, 99, 271, 102, 298, 395, 400, 4, 468, 452, 325, 295, 277, 464, 421, 105, 348, 78, 221, 425, 236, 330, 80, 112, 282, 278, 188, 168, 174, 127, 498, 22, 96, 246, 494, 206, 162, 216, 118, 419, 418, 53, 245, 410, 447, 197, 479, 23, 69, 146, 94, 225, 166, 30, 299, 442, 300, 337, 372, 196, 455, 250, 62, 496, 462, 338, 36, 215, 429, 255, 293, 40, 247, 427, 38, 128, 204, 256, 444, 292, 177, 120, 25, 156, 165, 371, 383, 211, 483, 375, 251, 102, 86, 414, 97, 491, 282, 497, 181, 434, 450, 108, 468, 277, 266, 263, 81, 271, 69, 4, 452, 99, 298, 168, 479, 400, 351, 295, 325, 54, 5, 161, 464, 395, 421, 330, 197, 458, 16, 105, 348, 425, 22, 216, 118, 17, 245, 236, 221, 127, 77, 80, 206, 146, 278, 265, 174, 397, 377, 191, 94, 225, 30, 98, 300, 442, 196, 337, 372, 250, 496, 215, 62, 462, 429, 455, 40, 36, 427, 204, 293, 38, 338, 128, 292, 165, 256, 444, 25, 371, 483, 251, 86, 177, 383, 414, 120, 156, 211, 97, 497, 102, 491, 434, 181, 375, 81, 450, 108, 266, 263, 400, 452, 468, 271, 395, 298, 351, 282, 99, 295, 277, 325, 464, 330, 421, 4, 105, 348, 69, 188, 168, 221, 22, 236, 197, 80, 216, 278, 118, 174, 479, 498, 246, 494, 245, 162, 96, 418, 146, 425, 53, 410, 16, 447, 54, 206, 23, 191, 5, 30, 225, 300, 299, 442, 372, 337, 196, 462, 455, 250, 62, 215, 204, 36, 496, 247, 256, 429, 338, 427, 40, 38, 255, 128, 293, 165, 177, 383, 102, 86, 444, 156, 292, 211, 483, 375, 120, 371, 25, 251, 414, 497, 282, 450, 452, 181, 263, 81, 266, 108, 434, 97, 491, 168, 277, 468, 69, 4, 298, 400, 197, 395, 479, 351, 271, 54, 5, 99, 161, 188, 295, 348, 105, 16, 421, 330, 325, 458, 498, 246, 494, 418, 464, 162, 53, 174, 410, 236, 23, 221, 447, 80, 278, 96, 78, 112, 357, 17, 425, 30, 225, 94, 442, 299, 300, 372, 98, 337, 462, 196, 455, 250, 215, 36, 256, 204, 62, 496, 338, 40, 247, 429, 165, 38, 427, 383, 128, 255, 293, 444, 102, 211, 177, 86, 120, 156, 483, 375, 292, 251, 263, 168, 434, 452, 81, 25, 414, 497, 97, 4, 371, 450, 282, 197, 181, 266, 491, 400, 108, 69, 277, 479, 395, 188, 271, 298, 5, 54, 99, 295, 161, 440, 351, 325, 468, 246, 498, 494, 418, 330, 162, 421, 458, 53, 464, 410, 23, 348, 447, 436, 16, 195, 17, 77, 105, 205, 425, 265, 206, 94, 442, 462, 372, 337, 256, 98, 250, 165, 215, 247, 86, 102, 427, 36, 429, 38, 383, 177, 128, 62, 496, 483, 211, 338, 375, 40, 156, 452, 293, 255, 81, 251, 168, 266, 450, 371, 497, 108, 282, 263, 444, 292, 414, 400, 188, 4, 69, 395, 120, 298, 434, 436, 440, 25, 181, 418, 139, 246, 498, 494, 53, 468, 348, 410, 162, 16, 479, 23, 447, 403, 58, 277, 351, 6, 95, 356, 318, 330, 296, 5, 234, 54, 491, 105, 97, 161, 271, 174, 96, 421, 195, 295, 458, 101, 116, 236, 80, 29, 278, 429, 211, 271, 462, 295, 206, 414, 371, 256, 325, 263, 421, 483, 464, 105, 281, 353, 314, 192, 298, 362, 205, 440, 96, 168, 330, 251, 122, 132, 174, 146, 397, 22, 93, 15, 12, 17, 348, 216, 375, 113, 400, 265, 221, 369, 499, 104, 357, 80, 77, 485, 479, 268, 236, 323, 118, 254, 65, 481, 301, 460, 1, 237, 152, 0, 245, 473, 393, 125, 441, 408, 228, 278, 404, 468, 361, 63, 284, 276, 171, 232, 319, 142, 87, 436, 48, 311, 227, 347, 130, 407, 191, 39, 49, 446, 45, 270, 437, 111, 131]

        preds2 = exp.recommend(users = [1, 2], exclude_known=False)
        assert preds2['user'].unique().tolist() == [1,2]

        preds = exp.recommend(exclude_known=True)
        joined_preds = preds.join(
            data.set_index(['user', 'item']),
            on=['user','item'], how='inner'
        )
        assert len(joined_preds) == 0
