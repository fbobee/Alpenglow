import alpenglow as prs
from alpenglow.offline.models import NearestNeighborModel
import alpenglow.Getter as rs
import pandas as pd
import numpy as np
import unittest


class TestNearestNeighborModel(unittest.TestCase):
    def test_rmse(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        model = NearestNeighborModel()
        model.fit(data)

        def predict(model, user, item):
            rd = rs.RecDat()
            rd.user = user
            rd.item = item
            return model.prediction(rd)

        errors = [(1 - predict(model.model, u, i))**2 for (u, i) in data[['user', 'item']].values]
        rmse = np.sqrt(pd.Series(errors)).mean()
        self.assertAlmostEqual(53.651, rmse)

    def test_ranking(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        exp = NearestNeighborModel()
        exp.fit(data)
        preds = exp.recommend()

        assert preds['item'].tolist() ==  \
            [94, 166, 225, 300, 30, 455, 299, 337, 250, 338, 468, 473, 4, 442, 375, 128, 204, 234, 161, 6, 407, 215, 5, 371, 331, 277, 197, 497, 425, 196, 462, 168, 260, 247, 156, 266, 496, 483, 216, 429, 263, 282, 434, 498, 409, 270, 493, 165, 461, 255, 293, 440, 403, 54, 397, 17, 95, 330, 361, 49, 86, 452, 436, 458, 69, 377, 211, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 319, 444, 38, 122, 336, 125, 79, 113, 427, 318, 296, 251, 383, 380, 256, 420, 120, 1, 97, 99, 484, 372, 300, 299, 250, 204, 215, 40, 165, 496, 86, 427, 371, 440, 266, 330, 255, 234, 452, 425, 16, 498, 122, 461, 434, 331, 409, 403, 493, 95, 484, 361, 497, 6, 407, 450, 436, 429, 181, 488, 485, 362, 464, 319, 273, 336, 125, 79, 72, 318, 296, 251, 197, 380, 270, 420, 145, 1, 97, 99, 111, 108, 290, 45, 216, 164, 178, 205, 29, 474, 353, 295, 301, 27, 136, 15, 414, 284, 58, 454, 400, 491, 210, 116, 49, 325, 483, 271, 473, 105, 200, 421, 348, 499, 134, 356, 260, 292, 388, 93, 406, 468, 166, 225, 30, 442, 299, 337, 250, 196, 256, 247, 204, 40, 120, 375, 165, 86, 444, 260, 266, 293, 397, 145, 49, 69, 377, 440, 450, 36, 483, 216, 452, 383, 425, 17, 197, 277, 493, 270, 331, 473, 403, 54, 290, 95, 330, 361, 474, 301, 136, 4, 409, 458, 436, 211, 296, 181, 461, 156, 488, 485, 102, 177, 5, 79, 215, 234, 125, 336, 498, 122, 38, 113, 434, 318, 407, 251, 319, 380, 282, 420, 16, 1, 97, 99, 484, 108, 62, 45, 29, 205, 178, 164, 111, 479, 263, 353, 161, 27, 6, 128, 30, 94, 166, 225, 300, 337, 372, 299, 462, 196, 468, 473, 4, 383, 375, 128, 204, 234, 161, 216, 407, 215, 5, 371, 331, 277, 197, 497, 425, 86, 6, 455, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 293, 440, 403, 54, 397, 17, 95, 330, 361, 49, 452, 250, 436, 458, 69, 377, 211, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 98, 318, 296, 251, 256, 380, 270, 420, 168, 1, 97, 99, 484, 120, 30, 300, 442, 166, 225, 462, 94, 204, 299, 250, 468, 371, 4, 497, 375, 128, 372, 455, 6, 216, 161, 234, 5, 461, 331, 473, 277, 197, 361, 425, 260, 168, 293, 247, 156, 266, 496, 483, 319, 429, 263, 282, 407, 498, 215, 338, 493, 165, 484, 255, 452, 440, 403, 54, 397, 17, 95, 330, 98, 49, 86, 436, 458, 69, 377, 145, 211, 450, 181, 36, 427, 488, 485, 102, 177, 62, 362, 16, 383, 444, 38, 122, 336, 125, 79, 113, 434, 318, 296, 251, 409, 380, 270, 420, 256, 1, 97, 99, 120, 337, 166, 30, 225, 462, 98, 372, 299, 196, 337, 455, 204, 247, 256, 62, 156, 483, 375, 102, 108, 234, 397, 427, 452, 361, 95, 425, 250, 69, 211, 440, 497, 403, 197, 4, 468, 277, 5, 473, 338, 409, 215, 296, 493, 461, 255, 331, 29, 178, 54, 17, 434, 330, 498, 49, 407, 145, 377, 458, 371, 450, 181, 36, 282, 336, 263, 429, 319, 216, 161, 16, 362, 444, 38, 122, 177, 125, 79, 113, 496, 318, 485, 251, 488, 380, 270, 420, 266, 1, 97, 99, 484, 6, 290, 45, 260, 205, 168, 164, 111, 120, 30, 94, 166, 225, 442, 299, 204, 98, 455, 372, 256, 337, 86, 250, 128, 425, 197, 383, 473, 375, 4, 468, 461, 371, 403, 277, 330, 497, 145, 427, 338, 498, 234, 282, 429, 161, 6, 216, 122, 263, 113, 407, 251, 215, 420, 5, 99, 255, 331, 483, 260, 54, 17, 95, 496, 361, 49, 102, 247, 293, 377, 458, 266, 156, 36, 440, 181, 450, 488, 485, 211, 177, 62, 362, 16, 319, 444, 38, 436, 336, 125, 79, 397, 434, 318, 296, 69, 409, 380, 270, 452, 493, 1, 97, 168, 484, 108, 290, 45, 120, 225, 94, 166, 442, 300, 337, 455, 372, 98, 256, 4, 375, 197, 383, 128, 468, 234, 161, 216, 6, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 204, 260, 247, 488, 266, 293, 496, 483, 444, 429, 263, 282, 318, 498, 380, 338, 1, 165, 461, 255, 331, 403, 54, 440, 450, 95, 330, 361, 49, 86, 250, 145, 397, 211, 436, 69, 458, 181, 36, 156, 377, 485, 102, 177, 62, 362, 16, 319, 427, 38, 122, 336, 125, 79, 113, 434, 452, 296, 251, 409, 462, 270, 420, 493, 168, 97, 99, 484, 108, 120, 166, 300, 442, 337, 372, 455, 196, 462, 250, 215, 338, 496, 86, 247, 427, 102, 23, 162, 293, 69, 452, 425, 497, 403, 95, 361, 197, 145, 397, 440, 383, 256, 277, 473, 4, 371, 296, 407, 375, 128, 409, 5, 165, 461, 255, 331, 29, 54, 111, 17, 468, 330, 282, 49, 263, 234, 429, 377, 458, 436, 211, 450, 319, 216, 161, 16, 362, 485, 483, 488, 156, 444, 38, 122, 336, 125, 79, 113, 434, 318, 36, 251, 181, 380, 270, 420, 493, 1, 97, 99, 484, 108, 290, 45, 266, 205, 178, 164, 6, 260, 94, 166, 30, 225, 442, 462, 337, 98, 300, 455, 299, 120, 128, 247, 427, 425, 452, 197, 473, 4, 468, 371, 255, 277, 54, 497, 330, 196, 250, 69, 215, 375, 407, 282, 263, 234, 429, 216, 122, 125, 113, 498, 251, 5, 165, 461, 99, 331, 45, 403, 161, 483, 17, 95, 102, 361, 49, 86, 496, 145, 377, 458, 6, 488, 156, 36, 266, 181, 450, 485, 440, 177, 62, 362, 16, 319, 444, 38, 211, 336, 436, 79, 397, 434, 318, 296, 260, 409, 380, 270, 420, 493, 1, 97, 293, 484, 108, 290, 204, 168, 94, 225, 166, 442, 98, 337, 462, 196, 338, 452, 383, 473, 425, 427, 256, 168, 4, 407, 234, 128, 375, 371, 461, 277, 197, 497, 361, 86, 145, 69, 468, 161, 483, 177, 496, 6, 216, 429, 263, 282, 434, 498, 215, 270, 5, 165, 484, 255, 331, 403, 54, 17, 95, 330, 247, 49, 156, 250, 266, 377, 458, 436, 36, 181, 440, 450, 211, 488, 485, 102, 397, 62, 362, 16, 319, 444, 38, 122, 336, 125, 79, 113, 260, 318, 296, 251, 409, 380, 293, 420, 493, 1, 97, 99, 204, 108, 290, 45, 29, 120, 30, 94, 225, 299, 372, 337, 98, 250, 455, 256, 204, 165, 40, 69, 425, 452, 383, 473, 4, 468, 371, 338, 255, 277, 197, 497, 361, 427, 145, 397, 375, 498, 282, 234, 128, 263, 429, 161, 336, 407, 434, 215, 409, 5, 493, 461, 484, 331, 29, 403, 54, 17, 95, 330, 216, 49, 86, 177, 483, 377, 458, 436, 6, 496, 488, 156, 247, 36, 485, 102, 181, 62, 362, 16, 319, 444, 38, 122, 266, 125, 79, 113, 450, 318, 296, 251, 211, 380, 270, 420, 440, 1, 97, 99, 260, 108, 290, 45, 293, 168, 94, 166, 300, 372, 98, 462, 455, 204, 40, 250, 452, 497, 427, 293, 383, 256, 168, 4, 215, 407, 371, 473, 277, 197, 17, 425, 49, 69, 397, 440, 375, 128, 234, 429, 362, 216, 263, 282, 79, 498, 296, 338, 5, 165, 461, 255, 331, 403, 54, 161, 483, 95, 330, 361, 488, 86, 496, 145, 377, 458, 436, 211, 156, 36, 247, 181, 450, 485, 102, 177, 266, 16, 319, 444, 38, 122, 336, 125, 6, 113, 434, 318, 260, 251, 409, 380, 270, 420, 493, 1, 97, 99, 484, 108, 290, 45, 29, 205, 178, 468, 181, 414, 105, 348, 292, 80, 278, 298, 23, 221, 351, 395, 174, 96, 410, 369, 357, 246, 78, 494, 418, 53, 447, 162, 236, 419, 188, 112, 139, 101, 498, 94, 30, 166, 442, 225, 196, 98, 462, 299, 455, 468, 128, 4, 497, 375, 204, 372, 161, 6, 483, 282, 234, 338, 165, 371, 473, 277, 197, 361, 425, 260, 168, 293, 266, 156, 440, 247, 496, 319, 216, 429, 263, 434, 407, 498, 215, 493, 5, 484, 461, 255, 331, 452, 403, 54, 17, 95, 330, 397, 49, 86, 250, 211, 69, 436, 458, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 383, 318, 296, 251, 409, 380, 270, 420, 256, 1, 97, 99, 120, 337, 225, 94, 299, 166, 442, 337, 300, 455, 372, 98, 256, 4, 197, 383, 375, 128, 468, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 6, 204, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 293, 403, 54, 440, 211, 95, 330, 361, 49, 86, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 462, 380, 270, 420, 168, 1, 97, 99, 484, 120, 94, 225, 30, 442, 299, 462, 455, 372, 337, 196, 338, 102, 250, 86, 165, 62, 177, 6, 69, 260, 293, 425, 54, 497, 361, 427, 145, 397, 440, 266, 452, 468, 197, 255, 277, 473, 296, 434, 5, 371, 409, 461, 493, 331, 484, 403, 29, 17, 95, 330, 4, 49, 215, 336, 498, 377, 458, 436, 211, 450, 181, 36, 407, 319, 263, 375, 16, 362, 429, 216, 485, 444, 38, 122, 483, 125, 79, 113, 488, 318, 156, 251, 496, 380, 270, 420, 234, 1, 97, 99, 161, 108, 290, 45, 168, 205, 178, 164, 111, 120, 94, 300, 30, 166, 225, 299, 455, 250, 442, 462, 337, 338, 86, 247, 383, 497, 256, 4, 371, 128, 468, 5, 461, 473, 277, 197, 95, 425, 427, 69, 215, 375, 234, 263, 161, 168, 429, 216, 38, 282, 407, 498, 296, 409, 270, 165, 97, 255, 331, 6, 403, 54, 483, 17, 485, 330, 361, 49, 496, 260, 145, 377, 156, 36, 181, 266, 450, 211, 440, 488, 436, 102, 177, 62, 362, 16, 319, 444, 458, 122, 336, 125, 79, 113, 434, 318, 397, 251, 293, 380, 452, 420, 493, 1, 120, 99, 484, 108, 290, 372, 166, 442, 337, 372, 462, 196, 215, 338, 496, 40, 86, 247, 38, 156, 266, 165, 497, 427, 6, 397, 260, 293, 95, 54, 361, 69, 377, 440, 181, 488, 425, 383, 256, 331, 461, 197, 277, 270, 409, 473, 5, 97, 484, 255, 29, 403, 111, 17, 295, 330, 4, 49, 468, 145, 498, 458, 436, 211, 407, 371, 282, 485, 336, 263, 375, 122, 429, 444, 319, 216, 234, 125, 79, 113, 434, 318, 296, 251, 16, 380, 362, 420, 493, 1, 177, 99, 102, 108, 290, 45, 483, 205, 178, 164, 161, 479, 474, 353, 128, 168, 300, 442, 372, 462, 250, 62, 338, 371, 429, 260, 293, 452, 440, 6, 256, 168, 383, 277, 5, 473, 197, 497, 425, 196, 69, 397, 145, 266, 247, 496, 468, 498, 407, 282, 375, 4, 336, 215, 434, 296, 165, 461, 255, 331, 403, 54, 29, 17, 95, 330, 361, 49, 86, 263, 177, 377, 458, 436, 211, 450, 181, 36, 234, 102, 485, 216, 488, 156, 362, 16, 319, 444, 38, 122, 483, 125, 79, 113, 161, 318, 128, 251, 409, 380, 270, 420, 493, 1, 97, 99, 484, 108, 290, 45, 204, 205, 178, 164, 111, 120, 372, 455, 462, 256, 383, 215, 36, 338, 120, 102, 177, 444, 400, 277, 461, 473, 234, 498, 161, 4, 407, 282, 362, 319, 122, 5, 113, 331, 403, 54, 6, 263, 436, 440, 260, 458, 377, 397, 27, 211, 181, 289, 488, 485, 271, 105, 348, 16, 72, 145, 178, 336, 125, 79, 49, 434, 318, 296, 409, 380, 270, 420, 69, 361, 45, 290, 330, 484, 29, 205, 99, 164, 111, 479, 474, 353, 295, 301, 95, 136, 15, 284, 58, 454, 1, 493, 491, 210, 116, 265, 17, 273, 425, 200, 197, 499, 134, 356, 452, 168, 225, 166, 300, 299, 442, 98, 372, 337, 462, 455, 196, 86, 128, 204, 427, 496, 215, 383, 497, 256, 277, 473, 461, 371, 54, 197, 330, 425, 250, 377, 4, 468, 375, 498, 234, 282, 263, 122, 429, 161, 113, 407, 251, 380, 338, 5, 99, 331, 45, 403, 6, 216, 17, 95, 483, 361, 49, 260, 62, 145, 102, 458, 247, 293, 488, 266, 156, 36, 440, 485, 181, 177, 450, 362, 16, 319, 444, 38, 211, 336, 125, 79, 436, 434, 318, 296, 397, 409, 69, 270, 420, 493, 1, 97, 452, 484, 108, 290, 168, 120, 98, 455, 256, 338, 211, 371, 4, 468, 161, 69, 234, 375, 407, 473, 6, 427, 425, 260, 49, 397, 440, 266, 483, 216, 429, 282, 38, 336, 5, 461, 54, 403, 197, 331, 17, 95, 330, 361, 111, 145, 377, 458, 436, 284, 450, 181, 156, 488, 485, 177, 362, 16, 319, 444, 380, 122, 409, 125, 79, 113, 318, 296, 255, 277, 270, 420, 493, 1, 97, 99, 484, 108, 290, 45, 29, 205, 178, 164, 293, 479, 474, 353, 295, 301, 27, 136, 15, 414, 168, 58, 454, 289, 491, 210, 116, 265, 464, 325, 271, 120, 225, 30, 442, 300, 299, 372, 337, 462, 455, 250, 496, 429, 62, 177, 371, 215, 483, 196, 444, 247, 204, 128, 102, 36, 168, 293, 397, 377, 440, 266, 69, 452, 145, 49, 425, 95, 17, 497, 197, 383, 277, 290, 484, 331, 403, 54, 111, 474, 295, 361, 473, 86, 461, 420, 165, 458, 436, 450, 181, 380, 156, 488, 409, 251, 5, 375, 498, 407, 234, 79, 125, 336, 38, 263, 113, 434, 318, 296, 161, 319, 16, 270, 362, 493, 1, 99, 216, 108, 485, 45, 29, 205, 178, 164, 6, 479, 260, 353, 4, 468, 94, 30, 166, 442, 300, 337, 98, 455, 462, 196, 247, 338, 86, 40, 256, 204, 293, 427, 452, 497, 331, 197, 277, 54, 17, 425, 49, 250, 69, 397, 468, 473, 5, 371, 498, 79, 282, 375, 4, 407, 296, 215, 270, 493, 461, 255, 290, 403, 178, 263, 429, 95, 330, 361, 234, 216, 362, 145, 377, 458, 436, 211, 483, 161, 102, 485, 488, 496, 156, 177, 36, 16, 319, 444, 38, 122, 336, 125, 266, 113, 434, 318, 181, 251, 409, 380, 450, 420, 440, 1, 97, 99, 484, 108, 6, 45, 29, 205, 260, 168, 300, 98, 337, 196, 496, 128, 204, 338, 250, 62, 165, 97, 375, 234, 4, 161, 266, 6, 168, 440, 397, 260, 211, 181, 216, 263, 407, 498, 122, 5, 49, 95, 425, 293, 17, 484, 497, 54, 29, 361, 479, 353, 145, 377, 458, 436, 491, 450, 464, 156, 488, 485, 493, 362, 16, 319, 444, 38, 403, 336, 125, 79, 197, 331, 380, 409, 255, 277, 270, 420, 296, 1, 318, 99, 434, 108, 290, 45, 113, 178, 164, 111, 461, 474, 473, 295, 301, 27, 136, 15, 284, 58, 289, 400, 452, 210, 116, 265, 468, 120, 94, 166, 30, 442, 225, 196, 462, 98, 455, 299, 128, 256, 372, 247, 425, 4, 468, 473, 371, 375, 204, 215, 5, 461, 331, 277, 197, 497, 49, 250, 407, 234, 161, 216, 6, 168, 483, 496, 444, 429, 263, 282, 318, 498, 380, 338, 1, 165, 108, 255, 260, 102, 403, 54, 17, 95, 330, 361, 488, 86, 266, 145, 293, 440, 181, 450, 397, 211, 36, 156, 436, 485, 458, 177, 62, 362, 16, 319, 377, 38, 122, 336, 125, 79, 113, 434, 69, 296, 251, 409, 427, 270, 420, 493, 452, 97, 99, 484, 120, 337, 94, 225, 300, 98, 462, 196, 338, 165, 247, 383, 62, 38, 496, 266, 234, 161, 427, 6, 204, 54, 425, 260, 17, 69, 397, 440, 377, 436, 450, 483, 497, 197, 452, 256, 113, 215, 277, 498, 5, 251, 461, 255, 331, 403, 108, 45, 205, 95, 330, 361, 49, 86, 250, 145, 444, 458, 407, 211, 473, 181, 36, 156, 282, 362, 263, 371, 177, 102, 16, 319, 429, 485, 122, 336, 125, 79, 488, 434, 318, 296, 216, 409, 380, 270, 420, 493, 1, 97, 99, 484, 375, 290, 468, 29, 168, 178, 164, 111, 479, 120, 225, 94, 166, 442, 300, 337, 455, 372, 98, 256, 4, 375, 197, 383, 128, 468, 234, 161, 216, 6, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 204, 260, 247, 488, 266, 293, 496, 483, 444, 429, 263, 282, 318, 498, 380, 338, 1, 165, 461, 255, 331, 403, 54, 440, 450, 95, 330, 361, 49, 86, 250, 145, 397, 211, 436, 69, 458, 181, 36, 156, 377, 485, 102, 177, 62, 362, 16, 319, 427, 38, 122, 336, 125, 79, 113, 434, 452, 296, 251, 409, 462, 270, 420, 493, 168, 97, 99, 484, 108, 120, 94, 30, 166, 442, 225, 196, 98, 462, 299, 455, 468, 128, 4, 497, 375, 204, 372, 161, 6, 483, 282, 234, 338, 165, 371, 473, 277, 197, 361, 425, 260, 168, 293, 266, 156, 440, 247, 496, 319, 216, 429, 263, 434, 407, 498, 215, 493, 5, 484, 461, 255, 331, 452, 403, 54, 17, 95, 330, 397, 49, 86, 250, 211, 69, 436, 458, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 383, 318, 296, 251, 409, 380, 270, 420, 256, 1, 97, 99, 120, 337, 30, 94, 166, 225, 299, 462, 196, 98, 337, 372, 455, 250, 40, 383, 4, 468, 473, 375, 128, 204, 338, 498, 165, 371, 403, 277, 197, 497, 425, 145, 234, 282, 429, 161, 6, 216, 483, 260, 38, 263, 79, 407, 296, 215, 270, 5, 97, 461, 255, 331, 247, 485, 54, 17, 95, 330, 361, 49, 86, 266, 293, 377, 440, 36, 181, 397, 450, 211, 156, 488, 69, 102, 177, 62, 362, 16, 319, 444, 436, 122, 336, 125, 458, 113, 434, 318, 427, 251, 409, 380, 452, 420, 493, 1, 256, 99, 484, 108, 290, 168, 166, 225, 98, 30, 300, 442, 299, 372, 337, 247, 462, 455, 196, 86, 256, 128, 102, 177, 427, 497, 383, 277, 473, 461, 403, 197, 95, 425, 250, 145, 371, 4, 468, 375, 215, 234, 407, 263, 38, 429, 79, 498, 296, 338, 5, 165, 97, 255, 331, 161, 6, 54, 216, 17, 483, 330, 361, 49, 260, 62, 485, 377, 496, 293, 156, 266, 36, 181, 440, 488, 450, 211, 436, 458, 362, 16, 319, 444, 397, 122, 336, 125, 69, 113, 434, 318, 452, 251, 409, 380, 270, 420, 493, 1, 168, 99, 484, 108, 290, 120, 94, 30, 299, 166, 98, 442, 300, 372, 337, 196, 496, 250, 215, 383, 197, 468, 4, 375, 128, 204, 338, 407, 5, 371, 473, 277, 17, 497, 425, 86, 234, 161, 216, 6, 455, 483, 177, 260, 444, 429, 263, 282, 318, 498, 380, 420, 1, 165, 461, 255, 331, 247, 403, 54, 266, 293, 95, 330, 361, 49, 462, 440, 211, 397, 436, 458, 69, 450, 181, 36, 156, 488, 485, 102, 377, 362, 16, 319, 145, 38, 122, 336, 125, 79, 113, 434, 427, 296, 251, 409, 452, 270, 256, 493, 168, 97, 99, 484, 108, 120, 30, 300, 299, 442, 337, 372, 462, 455, 62, 338, 196, 496, 429, 371, 452, 383, 468, 497, 277, 4, 204, 461, 331, 197, 17, 425, 361, 69, 397, 440, 5, 473, 375, 407, 234, 128, 282, 263, 125, 498, 215, 251, 380, 165, 1, 255, 108, 45, 403, 54, 161, 16, 95, 330, 362, 49, 86, 145, 377, 458, 436, 211, 216, 6, 102, 483, 485, 488, 260, 177, 156, 36, 247, 319, 444, 38, 122, 336, 181, 79, 113, 434, 318, 296, 450, 409, 266, 270, 420, 493, 293, 97, 99, 484, 256, 290, 168, 29, 205, 120, 94, 300, 225, 166, 299, 98, 442, 372, 337, 462, 250, 86, 247, 156, 108, 450, 69, 425, 452, 197, 331, 473, 383, 277, 17, 497, 361, 427, 145, 397, 256, 371, 375, 4, 215, 407, 234, 128, 468, 498, 434, 338, 5, 165, 461, 255, 484, 290, 403, 54, 282, 263, 95, 330, 161, 49, 429, 177, 216, 377, 458, 436, 6, 483, 488, 496, 36, 181, 485, 102, 211, 62, 362, 16, 319, 444, 38, 122, 336, 125, 79, 113, 440, 318, 296, 251, 409, 380, 270, 420, 493, 1, 97, 99, 260, 293, 168, 45, 29, 120, 166, 299, 300, 98, 462, 455, 62, 196, 256, 120, 496, 69, 293, 260, 427, 497, 452, 204, 277, 383, 473, 197, 54, 425, 330, 49, 250, 397, 440, 266, 215, 371, 4, 407, 375, 282, 16, 498, 113, 5, 165, 461, 255, 331, 99, 403, 45, 205, 17, 95, 263, 361, 234, 86, 216, 145, 377, 458, 436, 211, 450, 181, 102, 483, 161, 485, 488, 177, 156, 362, 36, 319, 444, 38, 122, 336, 125, 79, 247, 434, 318, 296, 251, 409, 380, 270, 420, 493, 1, 97, 6, 484, 108, 290, 128, 29, 468, 178, 164, 168, 196, 62, 250, 215, 375, 444, 128, 427, 452, 234, 383, 247, 371, 473, 468, 161, 331, 6, 4, 54, 69, 397, 440, 266, 458, 496, 483, 216, 429, 263, 425, 5, 497, 260, 434, 165, 461, 255, 97, 403, 290, 17, 95, 330, 361, 49, 86, 15, 145, 377, 498, 436, 450, 181, 488, 485, 102, 177, 197, 362, 16, 319, 125, 336, 407, 122, 79, 113, 282, 318, 296, 251, 409, 380, 270, 420, 493, 1, 277, 99, 484, 108, 293, 45, 29, 205, 178, 164, 111, 479, 474, 353, 295, 301, 27, 136, 204, 414, 284, 168, 166, 30, 225, 442, 299, 462, 372, 337, 338, 496, 383, 40, 497, 161, 263, 6, 483, 440, 260, 452, 397, 49, 436, 181, 488, 216, 444, 407, 498, 215, 69, 330, 95, 17, 425, 54, 403, 197, 164, 479, 353, 361, 136, 145, 377, 458, 210, 211, 325, 36, 484, 485, 362, 319, 97, 122, 336, 125, 79, 113, 434, 318, 331, 277, 493, 255, 420, 270, 461, 1, 473, 99, 380, 290, 45, 29, 205, 178, 409, 111, 251, 474, 296, 295, 301, 27, 5, 15, 414, 58, 454, 289, 400, 491, 234, 116, 265, 464, 4, 168, 337, 338, 256, 62, 102, 128, 40, 204, 156, 120, 97, 407, 234, 375, 263, 266, 161, 6, 397, 260, 69, 440, 488, 216, 362, 282, 336, 498, 434, 5, 49, 425, 452, 95, 497, 17, 54, 361, 479, 86, 145, 377, 458, 436, 450, 464, 273, 485, 499, 197, 383, 16, 319, 122, 403, 125, 79, 113, 331, 318, 296, 409, 277, 493, 420, 461, 1, 270, 99, 484, 108, 290, 45, 29, 205, 178, 164, 111, 380, 474, 353, 301, 27, 136, 15, 284, 58, 454, 289, 210, 116, 265, 165, 325, 473, 4, 200, 421, 468, 168, 94, 166, 30, 225, 455, 299, 442, 196, 462, 337, 250, 338, 425, 4, 468, 473, 375, 128, 204, 215, 407, 234, 5, 371, 331, 277, 197, 497, 49, 145, 161, 216, 6, 168, 483, 496, 260, 247, 444, 429, 263, 282, 318, 498, 380, 420, 1, 165, 461, 255, 488, 266, 403, 54, 17, 95, 330, 361, 293, 86, 440, 397, 452, 211, 436, 69, 450, 181, 36, 156, 458, 485, 102, 177, 62, 362, 16, 319, 377, 38, 122, 336, 125, 79, 113, 434, 427, 296, 251, 409, 383, 270, 256, 493, 120, 97, 99, 484, 108, 372, 225, 166, 299, 98, 372, 462, 455, 196, 120, 256, 452, 497, 427, 69, 277, 383, 4, 128, 375, 282, 371, 473, 331, 197, 17, 425, 49, 250, 377, 397, 234, 468, 161, 216, 62, 483, 429, 263, 125, 407, 498, 215, 5, 165, 461, 255, 108, 45, 403, 54, 6, 95, 330, 361, 496, 86, 488, 145, 247, 458, 436, 211, 156, 36, 266, 181, 450, 485, 102, 177, 440, 362, 16, 319, 444, 38, 122, 336, 260, 79, 113, 434, 318, 296, 251, 409, 380, 270, 420, 493, 1, 97, 99, 484, 293, 290, 204, 29, 205, 168, 94, 30, 299, 166, 442, 98, 300, 337, 372, 196, 40, 197, 468, 383, 4, 375, 128, 204, 407, 234, 161, 215, 5, 371, 473, 277, 17, 497, 425, 86, 216, 6, 455, 496, 260, 247, 266, 483, 444, 429, 263, 282, 318, 498, 380, 338, 1, 165, 461, 255, 331, 293, 403, 54, 462, 440, 95, 330, 361, 49, 211, 250, 397, 436, 458, 69, 377, 450, 181, 36, 156, 488, 485, 102, 177, 362, 16, 319, 145, 38, 122, 336, 125, 79, 113, 434, 427, 296, 251, 409, 452, 270, 420, 493, 256, 97, 99, 484, 108, 168, 225, 94, 299, 166, 442, 337, 300, 455, 372, 98, 256, 4, 197, 383, 375, 128, 468, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 6, 204, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 293, 403, 54, 440, 211, 95, 330, 361, 49, 86, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 462, 380, 270, 420, 168, 1, 97, 99, 484, 120, 455, 256, 36, 204, 427, 128, 4, 161, 468, 6, 440, 234, 375, 371, 425, 260, 497, 403, 330, 49, 69, 397, 450, 266, 247, 483, 216, 282, 407, 498, 197, 331, 461, 277, 1, 54, 17, 95, 178, 361, 474, 86, 145, 377, 458, 436, 400, 116, 156, 488, 485, 102, 177, 362, 16, 319, 38, 122, 336, 125, 79, 113, 409, 251, 165, 296, 380, 270, 420, 493, 318, 97, 484, 108, 290, 45, 29, 205, 5, 164, 111, 479, 473, 353, 295, 301, 27, 136, 15, 414, 284, 58, 454, 289, 452, 210, 383, 265, 464, 168, 98, 300, 372, 337, 462, 455, 196, 250, 293, 483, 6, 69, 440, 161, 427, 260, 128, 497, 197, 461, 54, 425, 330, 49, 145, 397, 436, 266, 247, 485, 277, 452, 473, 498, 407, 371, 5, 165, 420, 255, 331, 403, 29, 164, 17, 95, 27, 361, 58, 86, 383, 282, 377, 458, 263, 211, 450, 181, 156, 488, 375, 102, 319, 16, 429, 362, 38, 122, 336, 125, 79, 113, 318, 296, 251, 409, 380, 270, 177, 493, 1, 99, 484, 108, 290, 45, 216, 178, 234, 111, 479, 474, 295, 301, 4, 136, 15, 284, 468, 204, 94, 225, 30, 442, 299, 98, 300, 462, 337, 372, 468, 4, 197, 383, 375, 128, 204, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 6, 455, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 293, 403, 54, 440, 211, 95, 330, 361, 49, 86, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 256, 380, 270, 420, 168, 1, 97, 99, 484, 120, 98, 299, 338, 62, 247, 429, 496, 371, 128, 383, 36, 293, 69, 461, 425, 497, 498, 277, 452, 407, 362, 282, 444, 215, 79, 5, 409, 255, 331, 97, 488, 181, 263, 473, 458, 377, 216, 145, 414, 454, 400, 485, 265, 325, 16, 319, 421, 122, 336, 125, 479, 113, 434, 251, 49, 380, 270, 420, 493, 1, 161, 99, 361, 178, 205, 330, 29, 45, 164, 111, 17, 474, 353, 295, 301, 27, 136, 15, 290, 284, 484, 289, 54, 491, 210, 116, 397, 464, 260, 40, 271, 273, 105, 200, 468, 348, 499, 134, 72, 120, 442, 372, 196, 62, 338, 86, 156, 128, 165, 375, 234, 161, 282, 371, 4, 168, 6, 361, 95, 427, 69, 397, 440, 266, 216, 263, 362, 407, 498, 336, 260, 425, 403, 331, 197, 293, 54, 17, 290, 330, 178, 49, 474, 145, 377, 458, 436, 211, 450, 181, 255, 488, 485, 177, 461, 277, 16, 319, 444, 122, 318, 125, 434, 113, 79, 5, 296, 251, 409, 380, 270, 420, 493, 1, 97, 99, 484, 108, 473, 45, 29, 205, 383, 164, 111, 479, 468, 353, 295, 301, 27, 136, 15, 414, 284, 58, 454, 289, 400, 120, 166, 300, 30, 94, 442, 225, 372, 196, 256, 337, 468, 4, 197, 383, 375, 128, 204, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 86, 6, 455, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 299, 403, 54, 293, 440, 95, 330, 361, 49, 211, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 98, 380, 270, 420, 168, 1, 97, 99, 484, 120, 94, 225, 372, 337, 98, 455, 204, 36, 250, 496, 338, 69, 293, 260, 425, 197, 452, 468, 473, 383, 371, 277, 54, 497, 361, 427, 145, 397, 440, 266, 498, 375, 4, 336, 282, 263, 319, 407, 434, 296, 5, 165, 461, 255, 331, 403, 29, 17, 95, 330, 429, 49, 86, 234, 216, 377, 458, 436, 211, 450, 181, 483, 161, 102, 485, 488, 177, 62, 362, 16, 156, 444, 38, 122, 247, 125, 79, 113, 6, 318, 128, 251, 409, 380, 270, 420, 493, 1, 97, 99, 484, 108, 290, 45, 168, 205, 178, 164, 111, 120, 30, 300, 299, 98, 337, 462, 455, 62, 247, 196, 338, 496, 250, 383, 165, 260, 293, 256, 69, 425, 452, 468, 17, 95, 361, 397, 440, 266, 211, 181, 497, 331, 197, 277, 473, 4, 204, 79, 5, 296, 461, 255, 493, 97, 403, 54, 29, 178, 111, 330, 215, 49, 86, 375, 145, 377, 458, 436, 498, 450, 319, 36, 407, 234, 362, 282, 177, 263, 102, 16, 485, 444, 38, 122, 336, 125, 216, 113, 434, 318, 488, 251, 409, 380, 270, 420, 156, 1, 483, 99, 484, 108, 290, 45, 161, 205, 6, 164, 168, 120, 30, 225, 94, 166, 442, 372, 337, 98, 300, 455, 256, 120, 497, 4, 468, 371, 375, 128, 204, 234, 282, 161, 5, 461, 331, 473, 277, 197, 49, 425, 429, 483, 6, 260, 496, 247, 293, 266, 444, 216, 125, 263, 318, 407, 498, 215, 1, 165, 108, 255, 488, 403, 54, 440, 17, 95, 330, 361, 452, 86, 250, 145, 397, 181, 450, 69, 211, 436, 36, 156, 458, 485, 102, 177, 62, 362, 16, 319, 377, 38, 122, 336, 427, 79, 113, 434, 196, 296, 251, 409, 380, 270, 420, 493, 383, 97, 99, 484, 462, 168, 299, 442, 98, 300, 337, 372, 462, 455, 62, 256, 497, 277, 196, 452, 383, 468, 4, 375, 234, 128, 371, 473, 255, 197, 54, 425, 330, 427, 69, 397, 204, 161, 216, 102, 483, 6, 429, 263, 282, 407, 498, 215, 338, 5, 165, 461, 99, 331, 45, 403, 496, 36, 17, 95, 247, 361, 49, 86, 250, 145, 377, 458, 181, 450, 266, 211, 436, 156, 488, 485, 440, 177, 260, 362, 16, 319, 444, 38, 122, 336, 125, 79, 113, 434, 318, 296, 251, 409, 380, 270, 420, 493, 1, 97, 293, 484, 108, 290, 168, 120, 442, 299, 196, 62, 250, 427, 120, 156, 496, 215, 429, 440, 234, 266, 331, 461, 397, 6, 485, 498, 407, 362, 444, 255, 125, 113, 403, 17, 95, 330, 263, 425, 260, 353, 211, 436, 377, 450, 181, 36, 58, 488, 491, 265, 325, 319, 105, 38, 122, 336, 216, 79, 473, 434, 318, 296, 251, 409, 380, 270, 420, 493, 45, 290, 108, 145, 484, 99, 49, 205, 178, 164, 111, 474, 97, 295, 301, 27, 136, 15, 414, 284, 1, 454, 289, 400, 361, 210, 483, 464, 371, 40, 271, 273, 293, 200, 421, 348, 499, 4, 299, 372, 98, 337, 455, 62, 496, 128, 247, 36, 338, 250, 497, 375, 483, 234, 266, 397, 161, 6, 69, 427, 145, 440, 450, 156, 485, 177, 216, 282, 260, 425, 403, 293, 468, 493, 331, 197, 97, 54, 17, 95, 330, 361, 49, 295, 27, 377, 458, 436, 255, 181, 296, 461, 277, 102, 5, 79, 362, 16, 319, 444, 473, 125, 336, 498, 122, 113, 434, 318, 38, 251, 409, 380, 270, 420, 407, 1, 371, 99, 484, 108, 290, 45, 29, 205, 178, 164, 111, 479, 474, 353, 4, 301, 168, 136, 15, 414, 284, 120, 300, 455, 196, 62, 38, 177, 452, 234, 383, 161, 247, 371, 473, 277, 6, 4, 17, 425, 427, 69, 397, 266, 211, 216, 263, 282, 407, 498, 5, 165, 260, 403, 331, 497, 54, 1, 484, 95, 330, 361, 49, 86, 145, 377, 458, 436, 491, 450, 181, 488, 485, 102, 255, 434, 362, 16, 319, 113, 122, 336, 125, 79, 461, 197, 318, 296, 251, 409, 380, 270, 420, 493, 293, 99, 128, 108, 290, 45, 29, 205, 178, 164, 111, 474, 353, 301, 27, 136, 15, 284, 58, 454, 289, 400, 468, 210, 116, 265, 271, 204, 30, 300, 442, 166, 225, 462, 94, 204, 299, 250, 468, 371, 4, 497, 375, 128, 372, 455, 6, 216, 161, 234, 5, 461, 331, 473, 277, 197, 361, 425, 260, 168, 293, 247, 156, 266, 496, 483, 319, 429, 263, 282, 407, 498, 215, 338, 493, 165, 484, 255, 452, 440, 403, 54, 397, 17, 95, 330, 98, 49, 86, 436, 458, 69, 377, 145, 211, 450, 181, 36, 427, 488, 485, 102, 177, 62, 362, 16, 383, 444, 38, 122, 336, 125, 79, 113, 434, 318, 296, 251, 409, 380, 270, 420, 256, 1, 97, 99, 120, 337, 225, 94, 299, 166, 442, 337, 300, 455, 372, 98, 256, 4, 197, 383, 375, 128, 468, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 6, 204, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 293, 403, 54, 440, 211, 95, 330, 361, 49, 86, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 462, 380, 270, 420, 168, 1, 97, 99, 484, 120, 30, 166, 98, 300, 442, 372, 337, 62, 462, 455, 427, 496, 383, 497, 468, 4, 371, 128, 204, 375, 498, 234, 165, 473, 277, 197, 330, 425, 196, 377, 282, 429, 161, 6, 216, 483, 260, 362, 122, 263, 113, 407, 251, 215, 338, 5, 99, 461, 331, 403, 54, 102, 17, 95, 247, 361, 49, 86, 250, 145, 293, 458, 266, 156, 36, 440, 181, 450, 488, 485, 397, 177, 211, 436, 16, 319, 444, 38, 69, 336, 125, 79, 452, 434, 318, 296, 256, 409, 380, 270, 420, 493, 1, 97, 168, 484, 108, 290, 45, 120, 94, 166, 225, 300, 30, 455, 299, 337, 250, 338, 468, 473, 4, 442, 375, 128, 204, 234, 161, 6, 407, 215, 5, 371, 331, 277, 197, 497, 425, 196, 462, 168, 260, 247, 156, 266, 496, 483, 216, 429, 263, 282, 434, 498, 409, 270, 493, 165, 461, 255, 293, 440, 403, 54, 397, 17, 95, 330, 361, 49, 86, 452, 436, 458, 69, 377, 211, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 319, 444, 38, 122, 336, 125, 79, 113, 427, 318, 296, 251, 383, 380, 256, 420, 120, 1, 97, 99, 484, 372, 30, 94, 225, 300, 98, 442, 372, 337, 462, 455, 128, 102, 256, 496, 427, 383, 197, 468, 473, 375, 4, 204, 165, 371, 54, 277, 330, 497, 425, 196, 338, 498, 234, 282, 429, 161, 6, 216, 122, 263, 113, 407, 251, 215, 420, 5, 99, 461, 331, 403, 483, 260, 17, 95, 62, 361, 49, 86, 250, 145, 377, 458, 177, 266, 293, 485, 488, 440, 156, 36, 397, 181, 450, 362, 16, 319, 444, 38, 211, 336, 125, 79, 436, 434, 318, 296, 69, 409, 380, 270, 452, 493, 1, 97, 168, 484, 108, 290, 45, 120, 225, 30, 300, 299, 337, 442, 462, 372, 455, 250, 338, 425, 468, 383, 4, 473, 128, 204, 215, 375, 407, 371, 461, 277, 197, 497, 95, 196, 427, 69, 263, 234, 161, 216, 6, 483, 485, 429, 38, 282, 79, 498, 296, 409, 5, 165, 97, 255, 331, 496, 403, 54, 260, 17, 247, 330, 361, 49, 86, 266, 145, 377, 293, 450, 211, 440, 181, 36, 156, 488, 436, 102, 177, 62, 362, 16, 319, 444, 458, 122, 336, 125, 397, 113, 434, 318, 452, 251, 256, 380, 270, 420, 493, 1, 168, 99, 484, 108, 290, 120, 94, 225, 30, 442, 299, 98, 300, 462, 337, 372, 468, 4, 197, 383, 375, 128, 204, 234, 161, 216, 407, 215, 5, 371, 473, 277, 17, 497, 425, 196, 6, 455, 260, 247, 156, 266, 496, 483, 319, 429, 263, 282, 434, 498, 409, 338, 493, 165, 461, 255, 331, 293, 403, 54, 440, 211, 95, 330, 361, 49, 86, 250, 397, 436, 458, 69, 377, 450, 181, 36, 145, 488, 485, 102, 177, 62, 362, 16, 427, 444, 38, 122, 336, 125, 79, 113, 452, 318, 296, 251, 256, 380, 270, 420, 168, 1, 97, 99, 484, 120, 94, 442, 98, 337, 372, 462, 62, 250, 86, 247, 168, 256, 260, 397, 293, 427, 425, 497, 452, 277, 461, 473, 54, 95, 361, 69, 145, 440, 266, 181, 371, 215, 375, 383, 498, 336, 407, 282, 434, 338, 5, 165, 493, 255, 331, 403, 29, 17, 111, 330, 263, 49, 234, 4, 429, 377, 458, 436, 211, 450, 216, 36, 161, 102, 485, 483, 177, 488, 362, 16, 319, 444, 38, 122, 156, 125, 79, 113, 496, 318, 296, 251, 409, 380, 270, 420, 6, 1, 97, 99, 484, 108, 290, 45, 128, 205, 178, 164, 468, 120, 462, 204, 256, 371, 429, 128, 102, 375, 383, 263, 234, 282, 498, 473, 468, 161, 86, 440, 6, 247, 483, 216, 362, 16, 122, 407, 113, 5, 165, 461, 397, 164, 95, 69, 17, 330, 361, 49, 136, 145, 377, 458, 436, 211, 488, 485, 200, 348, 134, 319, 54, 336, 125, 79, 497, 318, 296, 251, 409, 380, 270, 420, 290, 484, 403, 1, 45, 29, 205, 178, 493, 111, 479, 474, 353, 295, 301, 27, 331, 15, 414, 284, 58, 454, 289, 400, 210, 116, 265, 464, 325, 271, 273, 105, 197, 421, 260, 499, 452, 168]

        preds2 = exp.recommend(users = [1, 2], exclude_known=False)
        assert preds2['user'].unique().tolist() == [1,2]

        preds = exp.recommend(exclude_known=True)
        joined_preds = preds.join(
            data.set_index(['user', 'item']),
            on=['user','item'], how='inner'
        )
        assert len(joined_preds) == 0
