import alpenglow as prs
from alpenglow.offline.models import PopularityModel
import alpenglow.Getter as rs
import pandas as pd
import numpy as np
import unittest


class TestPopularityModel(unittest.TestCase):
    def test_rmse(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        model = PopularityModel()
        model.fit(data)

        def predict(model, user, item):
            rd = rs.RecDat()
            rd.user = user
            rd.item = item
            return model.prediction(rd)

        errors = [(1 - predict(model.model, u, i))**2 for (u, i) in data[['user', 'item']].values]
        rmse = np.sqrt(pd.Series(errors)).mean()
        self.assertAlmostEqual(0.37659443516678637, rmse)

    def test_ranking(self):
        data = pd.read_csv(
            "python/test_alpenglow/test_data_4",
            sep=' ',
            header=None,
            names=['time', 'user', 'item', 'id', 'score', 'eval']
        )
        exp = PopularityModel()
        exp.fit(data)
        preds = exp.recommend()

        print("toplist="+str(preds['item'].tolist()))
        assert preds['item'].tolist() ==  \
            [30, 94, 166, 225, 300, 299, 442, 196, 372, 462, 455, 337, 204, 256, 338, 62, 250, 427, 429, 128, 215, 247, 496, 165, 36, 40, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 371, 483, 444, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 300, 299, 204, 429, 427, 250, 40, 496, 215, 165, 255, 86, 483, 371, 452, 81, 266, 414, 450, 97, 497, 108, 468, 434, 292, 251, 25, 421, 330, 400, 197, 298, 491, 325, 295, 99, 440, 271, 16, 464, 181, 436, 314, 205, 395, 122, 105, 95, 356, 403, 234, 206, 296, 318, 93, 348, 127, 245, 22, 254, 425, 233, 191, 351, 362, 498, 195, 188, 58, 284, 488, 15, 118, 6, 281, 353, 216, 454, 478, 29, 12, 116, 192, 146, 45, 290, 484, 1, 493, 361, 420, 270, 380, 406, 388, 72, 409, 331, 134, 79, 30, 166, 225, 299, 442, 196, 337, 204, 256, 62, 250, 36, 40, 165, 383, 128, 247, 215, 293, 86, 177, 38, 156, 211, 120, 102, 282, 483, 375, 444, 452, 266, 450, 81, 97, 414, 168, 25, 4, 251, 108, 434, 263, 292, 69, 298, 325, 421, 330, 277, 479, 400, 197, 491, 181, 436, 458, 314, 271, 54, 99, 464, 205, 161, 5, 440, 395, 16, 488, 216, 118, 377, 192, 15, 397, 353, 132, 281, 356, 425, 348, 95, 17, 93, 403, 116, 265, 6, 29, 478, 296, 454, 289, 318, 113, 58, 498, 122, 234, 284, 30, 94, 166, 225, 300, 299, 98, 196, 372, 462, 455, 337, 204, 256, 338, 62, 250, 429, 427, 383, 128, 215, 247, 496, 165, 36, 40, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 371, 483, 444, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 30, 94, 166, 225, 300, 299, 442, 98, 372, 462, 455, 337, 256, 204, 338, 62, 427, 250, 429, 36, 128, 247, 496, 383, 165, 40, 215, 255, 86, 293, 38, 177, 282, 102, 156, 120, 211, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 263, 468, 251, 434, 25, 292, 108, 4, 277, 330, 325, 197, 400, 491, 295, 479, 298, 421, 69, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 30, 166, 225, 299, 98, 196, 372, 455, 462, 337, 256, 204, 62, 338, 427, 429, 250, 40, 496, 215, 247, 36, 255, 38, 177, 156, 211, 282, 102, 120, 371, 375, 444, 483, 450, 452, 97, 168, 497, 81, 266, 414, 468, 263, 4, 108, 251, 434, 25, 292, 69, 330, 197, 295, 277, 325, 491, 400, 479, 298, 181, 440, 458, 205, 464, 99, 5, 271, 54, 395, 161, 16, 314, 377, 397, 478, 95, 403, 425, 353, 356, 29, 17, 348, 93, 12, 265, 116, 284, 58, 6, 454, 296, 318, 498, 289, 113, 122, 216, 15, 30, 94, 166, 225, 299, 98, 442, 372, 455, 337, 256, 204, 338, 62, 429, 250, 427, 383, 128, 215, 40, 496, 247, 36, 255, 86, 177, 293, 38, 282, 102, 120, 156, 211, 371, 375, 444, 483, 497, 168, 97, 414, 266, 450, 81, 452, 4, 251, 108, 434, 468, 263, 25, 292, 325, 197, 330, 491, 295, 298, 479, 421, 277, 69, 400, 458, 271, 54, 99, 464, 5, 161, 395, 314, 16, 440, 205, 181, 436, 377, 425, 95, 17, 403, 348, 105, 29, 265, 116, 284, 58, 498, 15, 454, 296, 318, 113, 234, 6, 122, 94, 166, 225, 300, 442, 98, 196, 372, 455, 462, 337, 256, 204, 338, 62, 250, 429, 427, 128, 36, 383, 165, 215, 247, 496, 40, 255, 86, 177, 38, 293, 282, 156, 102, 211, 120, 375, 371, 444, 483, 497, 168, 97, 414, 266, 452, 450, 81, 263, 4, 434, 251, 25, 468, 292, 108, 325, 197, 330, 491, 295, 400, 298, 479, 421, 69, 277, 464, 54, 99, 5, 161, 205, 314, 395, 16, 271, 181, 436, 458, 440, 17, 95, 425, 403, 105, 116, 353, 29, 265, 15, 284, 498, 296, 318, 234, 58, 113, 6, 122, 166, 300, 442, 196, 372, 462, 455, 337, 256, 338, 429, 250, 427, 128, 383, 215, 247, 36, 165, 496, 255, 86, 38, 293, 211, 282, 120, 102, 156, 375, 371, 444, 483, 450, 452, 497, 97, 168, 414, 266, 263, 468, 108, 251, 434, 25, 4, 292, 69, 330, 295, 325, 491, 277, 400, 197, 479, 298, 421, 436, 458, 440, 205, 271, 99, 464, 5, 54, 395, 161, 16, 181, 314, 377, 397, 478, 95, 403, 425, 353, 356, 29, 17, 348, 93, 12, 265, 116, 284, 58, 6, 454, 296, 318, 289, 105, 113, 122, 216, 15, 30, 94, 166, 225, 300, 299, 442, 98, 196, 462, 455, 337, 204, 62, 429, 250, 427, 36, 496, 40, 165, 215, 247, 128, 255, 86, 177, 293, 38, 282, 102, 156, 120, 211, 375, 371, 444, 483, 452, 497, 168, 97, 414, 266, 450, 81, 25, 251, 4, 263, 434, 108, 292, 468, 479, 69, 330, 197, 325, 298, 400, 295, 421, 277, 491, 458, 271, 54, 464, 99, 5, 395, 314, 16, 161, 205, 181, 436, 440, 377, 425, 105, 95, 17, 348, 29, 265, 403, 116, 58, 284, 454, 6, 15, 289, 296, 318, 113, 498, 234, 94, 166, 225, 98, 442, 196, 462, 337, 256, 204, 338, 62, 250, 427, 429, 36, 40, 383, 247, 165, 128, 215, 496, 255, 86, 293, 177, 38, 282, 120, 102, 156, 211, 375, 371, 483, 444, 168, 497, 414, 97, 452, 81, 266, 450, 251, 108, 263, 434, 25, 292, 4, 468, 69, 421, 330, 197, 277, 325, 400, 295, 479, 491, 298, 436, 458, 271, 54, 464, 99, 5, 395, 16, 205, 314, 161, 181, 440, 377, 105, 425, 95, 17, 29, 403, 116, 265, 348, 58, 454, 15, 284, 289, 296, 318, 498, 113, 6, 234, 353, 30, 94, 225, 299, 98, 372, 455, 337, 256, 204, 62, 338, 429, 427, 250, 496, 247, 36, 40, 215, 383, 128, 165, 255, 293, 86, 38, 177, 120, 282, 102, 156, 211, 371, 444, 483, 375, 452, 497, 168, 414, 97, 81, 266, 450, 4, 251, 434, 108, 25, 263, 468, 292, 69, 421, 330, 197, 325, 491, 295, 277, 479, 298, 436, 458, 271, 54, 464, 99, 5, 205, 16, 161, 314, 440, 181, 377, 397, 425, 348, 95, 17, 105, 353, 29, 403, 356, 454, 289, 284, 6, 58, 296, 318, 498, 113, 234, 15, 116, 122, 94, 166, 300, 98, 372, 455, 462, 204, 256, 338, 250, 429, 427, 383, 496, 40, 165, 128, 247, 36, 215, 255, 293, 86, 177, 38, 211, 120, 282, 102, 156, 375, 371, 444, 483, 497, 414, 97, 168, 452, 81, 450, 266, 251, 434, 108, 263, 468, 292, 25, 4, 69, 479, 330, 197, 277, 400, 491, 421, 295, 298, 325, 436, 458, 440, 205, 271, 5, 99, 464, 395, 54, 314, 16, 161, 181, 377, 397, 348, 356, 17, 95, 425, 93, 105, 353, 29, 403, 116, 289, 454, 265, 296, 284, 318, 113, 498, 6, 58, 122, 414, 292, 298, 395, 181, 348, 188, 105, 498, 351, 96, 236, 112, 139, 162, 447, 174, 221, 494, 78, 418, 53, 23, 246, 357, 419, 369, 410, 278, 101, 80, 30, 94, 166, 225, 299, 98, 442, 196, 372, 455, 462, 337, 204, 256, 338, 62, 429, 427, 250, 36, 165, 215, 247, 496, 383, 128, 40, 255, 86, 293, 177, 38, 156, 282, 102, 120, 211, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 263, 468, 251, 434, 25, 108, 292, 4, 277, 330, 325, 197, 400, 491, 295, 479, 298, 421, 69, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 440, 181, 436, 458, 425, 95, 17, 403, 116, 29, 289, 265, 15, 498, 234, 296, 318, 284, 113, 6, 122, 216, 94, 166, 225, 300, 299, 98, 442, 196, 372, 455, 462, 337, 256, 204, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 30, 94, 225, 299, 442, 196, 372, 455, 462, 337, 62, 338, 250, 429, 427, 165, 496, 36, 215, 40, 255, 293, 38, 86, 177, 120, 211, 102, 156, 371, 444, 375, 483, 266, 450, 168, 497, 97, 452, 414, 81, 468, 25, 108, 251, 434, 292, 263, 4, 69, 330, 421, 325, 491, 277, 197, 400, 295, 298, 479, 181, 440, 436, 458, 54, 99, 464, 5, 271, 395, 16, 161, 314, 205, 377, 397, 93, 425, 6, 95, 348, 29, 17, 356, 478, 265, 403, 116, 58, 454, 234, 289, 296, 318, 113, 498, 353, 15, 122, 216, 30, 94, 166, 225, 300, 299, 442, 372, 462, 455, 337, 256, 338, 62, 250, 429, 427, 40, 383, 215, 247, 496, 165, 36, 128, 255, 86, 38, 177, 293, 282, 120, 211, 102, 156, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 108, 4, 251, 434, 25, 263, 292, 468, 69, 325, 330, 197, 491, 295, 479, 298, 400, 421, 277, 271, 54, 464, 99, 5, 161, 395, 314, 16, 181, 440, 436, 458, 205, 377, 95, 425, 17, 403, 105, 29, 116, 265, 284, 15, 58, 296, 454, 318, 113, 498, 122, 234, 6, 166, 442, 196, 372, 462, 337, 256, 338, 429, 427, 215, 128, 383, 165, 40, 496, 247, 255, 293, 86, 38, 177, 211, 156, 120, 282, 102, 375, 371, 483, 444, 266, 97, 414, 81, 168, 497, 468, 251, 108, 263, 434, 292, 4, 25, 69, 330, 325, 197, 277, 400, 491, 479, 421, 295, 181, 436, 458, 440, 314, 54, 205, 271, 99, 5, 464, 395, 16, 161, 488, 397, 377, 6, 425, 12, 15, 95, 353, 17, 93, 478, 192, 105, 29, 348, 116, 265, 289, 356, 296, 318, 498, 403, 234, 113, 216, 284, 58, 122, 362, 300, 442, 196, 372, 462, 256, 204, 62, 338, 429, 250, 40, 247, 165, 36, 215, 128, 496, 383, 255, 38, 293, 177, 86, 211, 120, 282, 102, 156, 371, 375, 483, 444, 452, 450, 266, 497, 97, 81, 414, 168, 468, 251, 108, 434, 292, 25, 263, 4, 69, 330, 421, 325, 197, 491, 400, 277, 295, 479, 181, 436, 458, 440, 205, 99, 54, 5, 464, 271, 395, 16, 161, 314, 377, 93, 397, 425, 6, 95, 348, 29, 17, 356, 478, 265, 403, 116, 58, 454, 234, 289, 296, 318, 113, 498, 353, 15, 122, 216, 362, 372, 455, 462, 256, 338, 215, 36, 383, 177, 120, 211, 102, 282, 444, 168, 452, 81, 434, 263, 4, 277, 491, 400, 330, 479, 295, 197, 69, 54, 440, 5, 161, 271, 181, 436, 205, 458, 99, 314, 16, 403, 318, 234, 113, 122, 362, 498, 348, 105, 265, 127, 188, 116, 488, 6, 289, 454, 296, 58, 15, 233, 206, 356, 195, 377, 351, 281, 192, 132, 146, 77, 29, 397, 17, 12, 353, 93, 95, 425, 478, 254, 284, 420, 270, 380, 409, 331, 461, 79, 125, 336, 72, 134, 499, 319, 473, 200, 273, 210, 136, 166, 225, 300, 299, 442, 98, 196, 372, 462, 455, 337, 204, 256, 62, 338, 427, 250, 429, 383, 128, 36, 247, 215, 496, 40, 86, 38, 177, 293, 120, 282, 102, 156, 211, 371, 444, 483, 375, 497, 168, 414, 97, 266, 450, 452, 434, 4, 251, 108, 468, 25, 263, 292, 325, 330, 197, 491, 295, 277, 479, 421, 69, 400, 298, 458, 271, 54, 99, 464, 5, 161, 395, 16, 314, 440, 205, 181, 436, 377, 425, 95, 17, 348, 105, 403, 265, 116, 284, 58, 498, 15, 454, 296, 318, 113, 234, 6, 122, 353, 289, 98, 455, 256, 338, 427, 429, 255, 38, 177, 293, 282, 156, 211, 120, 444, 483, 371, 375, 168, 97, 266, 414, 450, 25, 4, 468, 292, 108, 325, 421, 295, 330, 298, 479, 277, 69, 491, 197, 5, 16, 464, 436, 161, 314, 205, 458, 440, 99, 54, 181, 271, 318, 113, 22, 122, 191, 362, 234, 206, 105, 488, 296, 265, 116, 216, 127, 454, 289, 15, 58, 284, 254, 146, 377, 351, 118, 397, 281, 77, 233, 17, 353, 29, 6, 478, 95, 12, 192, 403, 356, 425, 348, 93, 132, 245, 79, 461, 125, 336, 407, 30, 225, 300, 299, 442, 196, 372, 462, 455, 337, 204, 62, 250, 429, 247, 383, 165, 215, 36, 128, 496, 86, 38, 293, 177, 156, 102, 483, 444, 375, 371, 450, 452, 168, 497, 81, 266, 434, 108, 292, 251, 468, 25, 263, 4, 69, 197, 479, 277, 421, 400, 295, 298, 491, 440, 181, 436, 458, 99, 271, 5, 464, 161, 54, 205, 16, 395, 488, 377, 397, 425, 118, 284, 95, 353, 17, 192, 132, 281, 93, 29, 478, 348, 356, 12, 105, 6, 116, 265, 296, 318, 113, 498, 403, 234, 454, 289, 362, 216, 58, 30, 94, 166, 300, 442, 98, 196, 455, 462, 337, 256, 204, 338, 250, 427, 429, 496, 36, 247, 40, 215, 255, 293, 86, 177, 38, 282, 156, 120, 211, 102, 371, 375, 444, 483, 452, 497, 414, 97, 168, 81, 266, 450, 263, 251, 434, 108, 468, 25, 4, 292, 479, 69, 330, 197, 277, 400, 491, 421, 295, 298, 325, 436, 458, 205, 271, 5, 99, 395, 464, 54, 314, 16, 161, 440, 181, 377, 397, 348, 356, 17, 95, 425, 93, 105, 353, 29, 403, 116, 289, 454, 265, 498, 296, 284, 318, 113, 6, 58, 122, 300, 98, 196, 337, 204, 338, 62, 250, 40, 496, 128, 165, 255, 293, 38, 120, 156, 211, 375, 444, 452, 168, 97, 450, 497, 266, 81, 434, 263, 4, 25, 292, 108, 468, 400, 197, 491, 298, 295, 479, 325, 277, 421, 5, 16, 161, 314, 440, 458, 99, 54, 464, 181, 271, 395, 436, 206, 122, 127, 498, 234, 245, 6, 22, 362, 488, 216, 356, 105, 265, 116, 77, 254, 191, 289, 58, 284, 377, 281, 146, 195, 353, 425, 132, 29, 95, 192, 397, 118, 15, 351, 93, 17, 478, 403, 12, 296, 318, 113, 188, 30, 94, 166, 225, 299, 98, 442, 196, 372, 455, 462, 337, 204, 256, 62, 338, 250, 429, 427, 36, 165, 215, 128, 247, 496, 40, 255, 86, 293, 177, 38, 282, 156, 102, 211, 120, 375, 371, 444, 483, 497, 168, 97, 414, 266, 452, 450, 81, 263, 4, 434, 251, 25, 468, 292, 108, 325, 197, 330, 491, 295, 400, 298, 479, 421, 69, 277, 464, 54, 99, 5, 161, 205, 314, 395, 16, 271, 181, 436, 458, 440, 17, 95, 425, 403, 105, 116, 353, 29, 265, 15, 284, 498, 296, 318, 234, 58, 113, 6, 122, 94, 225, 300, 98, 196, 462, 204, 256, 338, 62, 429, 250, 427, 247, 36, 496, 40, 165, 383, 215, 255, 86, 38, 177, 156, 211, 282, 102, 120, 483, 375, 444, 371, 450, 266, 497, 97, 452, 81, 168, 414, 25, 108, 251, 434, 468, 263, 292, 330, 325, 197, 400, 491, 298, 69, 479, 421, 277, 295, 181, 436, 458, 440, 161, 205, 54, 271, 464, 5, 99, 395, 314, 16, 377, 234, 6, 93, 353, 17, 348, 95, 356, 478, 12, 29, 265, 403, 289, 454, 318, 296, 425, 116, 105, 113, 15, 122, 397, 498, 216, 94, 166, 225, 300, 442, 98, 196, 372, 455, 462, 337, 256, 204, 338, 62, 250, 429, 427, 128, 36, 383, 165, 215, 247, 496, 40, 255, 86, 177, 38, 293, 282, 156, 102, 211, 120, 375, 371, 444, 483, 497, 168, 97, 414, 266, 452, 450, 81, 263, 4, 434, 251, 25, 468, 292, 108, 325, 197, 330, 491, 295, 400, 298, 479, 421, 69, 277, 464, 54, 99, 5, 161, 205, 314, 395, 16, 271, 181, 436, 458, 440, 17, 95, 425, 403, 105, 116, 353, 29, 265, 15, 284, 498, 296, 318, 234, 58, 113, 6, 122, 30, 94, 166, 225, 299, 98, 442, 196, 372, 455, 462, 337, 204, 256, 338, 62, 429, 427, 250, 36, 165, 215, 247, 496, 383, 128, 40, 255, 86, 293, 177, 38, 156, 282, 102, 120, 211, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 263, 468, 251, 434, 25, 108, 292, 4, 277, 330, 325, 197, 400, 491, 295, 479, 298, 421, 69, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 440, 181, 436, 458, 425, 95, 17, 403, 116, 29, 289, 265, 15, 498, 234, 296, 318, 284, 113, 6, 122, 216, 30, 94, 166, 225, 299, 98, 196, 372, 462, 455, 337, 204, 256, 62, 338, 429, 427, 250, 40, 383, 128, 215, 247, 36, 165, 255, 86, 38, 293, 177, 282, 156, 102, 211, 120, 375, 371, 483, 444, 497, 168, 97, 414, 452, 450, 81, 266, 25, 4, 251, 434, 468, 108, 263, 292, 197, 325, 330, 491, 295, 479, 298, 400, 421, 277, 69, 271, 54, 464, 99, 5, 161, 395, 314, 16, 181, 440, 436, 458, 205, 377, 95, 425, 17, 403, 105, 29, 116, 265, 284, 15, 58, 296, 498, 454, 318, 113, 122, 234, 6, 30, 166, 225, 300, 299, 98, 442, 196, 372, 462, 455, 337, 256, 338, 62, 427, 429, 250, 40, 165, 383, 128, 215, 496, 247, 36, 255, 86, 38, 293, 177, 156, 211, 102, 120, 371, 375, 444, 483, 497, 168, 414, 97, 266, 450, 452, 81, 4, 468, 251, 434, 108, 25, 263, 292, 325, 330, 197, 491, 295, 479, 298, 400, 421, 277, 69, 271, 54, 464, 99, 5, 161, 395, 314, 16, 181, 440, 436, 458, 205, 377, 95, 425, 17, 403, 105, 29, 116, 265, 284, 15, 58, 296, 454, 318, 113, 498, 122, 234, 6, 30, 94, 166, 300, 299, 442, 98, 196, 372, 455, 462, 337, 204, 256, 338, 429, 250, 427, 383, 36, 215, 247, 496, 128, 165, 255, 86, 38, 177, 293, 211, 282, 102, 120, 156, 375, 371, 444, 483, 497, 168, 97, 414, 266, 452, 450, 81, 263, 434, 4, 251, 25, 468, 292, 108, 197, 325, 330, 491, 298, 295, 421, 277, 69, 400, 479, 271, 54, 464, 99, 5, 161, 205, 314, 395, 16, 181, 436, 458, 440, 425, 95, 17, 403, 265, 105, 353, 29, 116, 284, 15, 58, 498, 296, 318, 234, 454, 113, 6, 122, 30, 300, 299, 442, 196, 372, 455, 462, 337, 204, 256, 62, 338, 429, 383, 128, 215, 36, 496, 165, 247, 40, 255, 177, 86, 38, 293, 211, 120, 102, 282, 156, 371, 375, 444, 483, 452, 497, 168, 97, 414, 81, 450, 266, 4, 263, 108, 251, 434, 25, 292, 468, 69, 421, 330, 197, 277, 491, 400, 298, 479, 295, 325, 436, 458, 440, 271, 99, 5, 395, 54, 464, 16, 161, 205, 181, 314, 377, 105, 397, 348, 95, 17, 15, 353, 29, 403, 425, 356, 234, 116, 454, 289, 58, 265, 318, 296, 113, 498, 6, 94, 166, 225, 300, 299, 442, 98, 372, 462, 337, 256, 62, 338, 429, 250, 427, 383, 36, 215, 247, 40, 165, 496, 128, 255, 86, 38, 177, 293, 120, 156, 282, 102, 211, 371, 375, 444, 483, 168, 497, 97, 452, 81, 414, 450, 108, 251, 434, 25, 263, 4, 468, 292, 69, 421, 330, 197, 277, 325, 400, 295, 491, 479, 298, 436, 458, 271, 464, 99, 5, 54, 395, 205, 16, 161, 314, 440, 181, 377, 397, 105, 425, 95, 17, 353, 29, 403, 265, 348, 454, 289, 284, 6, 58, 296, 318, 113, 498, 234, 15, 166, 300, 299, 98, 196, 455, 462, 204, 256, 62, 250, 427, 36, 165, 40, 215, 128, 383, 496, 247, 255, 86, 293, 177, 38, 211, 282, 102, 120, 156, 371, 444, 483, 375, 266, 450, 168, 97, 452, 497, 414, 81, 292, 25, 468, 251, 108, 434, 263, 4, 295, 69, 330, 421, 491, 400, 325, 197, 277, 298, 479, 181, 436, 440, 458, 54, 464, 5, 99, 161, 395, 16, 271, 314, 205, 377, 397, 17, 425, 348, 353, 95, 29, 105, 356, 93, 265, 403, 116, 6, 58, 454, 296, 318, 113, 289, 122, 498, 15, 234, 196, 204, 62, 429, 427, 250, 165, 40, 383, 247, 215, 128, 496, 255, 86, 177, 293, 102, 282, 483, 375, 444, 371, 168, 266, 450, 497, 97, 81, 452, 414, 263, 251, 25, 108, 468, 434, 4, 292, 400, 330, 479, 69, 325, 277, 295, 197, 491, 16, 181, 436, 458, 314, 54, 205, 271, 161, 99, 464, 5, 440, 395, 362, 146, 488, 216, 234, 195, 58, 284, 15, 377, 118, 281, 351, 12, 353, 478, 356, 93, 29, 17, 105, 403, 397, 348, 192, 116, 265, 296, 6, 318, 113, 95, 498, 454, 122, 425, 289, 132, 30, 166, 225, 299, 442, 372, 462, 337, 338, 383, 36, 40, 496, 215, 255, 120, 211, 444, 483, 97, 81, 452, 497, 414, 168, 4, 263, 434, 292, 25, 251, 421, 295, 479, 298, 69, 197, 277, 491, 325, 400, 330, 161, 440, 436, 458, 54, 205, 464, 99, 271, 5, 181, 314, 395, 318, 113, 498, 206, 122, 6, 245, 127, 362, 216, 488, 254, 348, 105, 265, 116, 77, 233, 22, 454, 377, 397, 15, 146, 195, 132, 353, 118, 95, 425, 17, 192, 281, 351, 58, 478, 289, 29, 403, 12, 93, 296, 234, 356, 191, 337, 256, 204, 338, 62, 165, 128, 40, 383, 86, 120, 282, 102, 156, 375, 97, 497, 450, 168, 452, 266, 263, 434, 4, 108, 468, 421, 325, 69, 479, 197, 277, 298, 5, 16, 161, 436, 440, 464, 395, 54, 205, 99, 314, 458, 296, 318, 498, 234, 6, 289, 122, 362, 356, 216, 488, 265, 113, 116, 58, 454, 397, 191, 377, 206, 127, 233, 245, 22, 188, 195, 17, 29, 132, 118, 77, 95, 281, 403, 93, 478, 353, 12, 425, 15, 284, 192, 254, 409, 79, 125, 336, 319, 499, 200, 273, 485, 407, 210, 136, 30, 94, 166, 225, 299, 442, 196, 372, 462, 455, 337, 204, 256, 62, 338, 250, 427, 429, 36, 165, 215, 128, 247, 496, 40, 383, 255, 86, 293, 177, 38, 282, 156, 102, 211, 120, 375, 371, 444, 483, 497, 168, 97, 414, 266, 452, 450, 81, 263, 4, 434, 251, 25, 468, 292, 108, 325, 197, 330, 491, 295, 400, 298, 479, 421, 69, 277, 464, 54, 99, 5, 161, 205, 314, 395, 16, 271, 181, 436, 458, 440, 17, 95, 425, 403, 105, 116, 353, 29, 265, 15, 284, 498, 296, 318, 234, 58, 113, 6, 122, 166, 225, 299, 98, 196, 372, 455, 462, 256, 204, 62, 250, 427, 429, 36, 128, 165, 40, 496, 383, 247, 215, 255, 86, 177, 293, 38, 282, 120, 211, 102, 156, 375, 371, 444, 483, 452, 414, 497, 97, 81, 450, 266, 168, 4, 263, 108, 251, 25, 434, 292, 468, 69, 421, 330, 197, 277, 491, 400, 298, 479, 295, 325, 436, 458, 271, 99, 5, 395, 464, 54, 16, 161, 205, 440, 181, 314, 377, 397, 348, 17, 95, 425, 15, 353, 29, 403, 105, 356, 234, 116, 454, 289, 58, 265, 498, 296, 318, 113, 6, 30, 94, 166, 300, 299, 442, 98, 196, 372, 455, 462, 337, 204, 256, 338, 429, 250, 427, 40, 128, 36, 383, 496, 247, 165, 215, 255, 86, 177, 38, 293, 211, 282, 102, 120, 156, 375, 371, 444, 483, 497, 168, 81, 97, 414, 266, 452, 450, 4, 251, 434, 25, 263, 468, 108, 292, 197, 325, 330, 491, 298, 295, 421, 277, 69, 400, 479, 54, 271, 99, 5, 161, 395, 314, 205, 16, 464, 181, 436, 458, 440, 425, 95, 17, 403, 265, 105, 353, 29, 116, 284, 15, 58, 498, 296, 318, 234, 454, 113, 6, 94, 166, 225, 300, 299, 98, 442, 196, 372, 455, 462, 337, 256, 204, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 455, 256, 204, 427, 128, 383, 165, 36, 247, 86, 177, 38, 156, 282, 102, 375, 483, 371, 168, 266, 452, 97, 450, 497, 81, 414, 4, 251, 108, 468, 400, 197, 421, 479, 330, 69, 295, 298, 277, 325, 16, 161, 205, 395, 314, 54, 458, 5, 440, 464, 436, 191, 22, 188, 122, 234, 362, 488, 348, 216, 498, 113, 105, 265, 116, 245, 127, 454, 58, 284, 377, 397, 351, 77, 281, 425, 146, 132, 192, 118, 195, 254, 29, 353, 95, 17, 12, 403, 15, 478, 6, 356, 318, 289, 296, 93, 233, 79, 125, 336, 300, 98, 196, 372, 462, 455, 337, 204, 429, 250, 427, 247, 383, 128, 165, 255, 86, 38, 177, 293, 211, 102, 282, 156, 483, 371, 375, 266, 450, 81, 497, 452, 468, 4, 251, 263, 25, 108, 69, 330, 295, 277, 421, 197, 491, 479, 298, 400, 325, 161, 395, 181, 436, 440, 458, 54, 99, 271, 5, 464, 16, 488, 377, 195, 58, 397, 15, 6, 146, 351, 77, 95, 192, 12, 29, 132, 356, 425, 93, 105, 478, 118, 116, 265, 403, 348, 296, 318, 113, 17, 498, 234, 122, 454, 289, 362, 216, 284, 281, 254, 30, 94, 225, 300, 299, 442, 98, 196, 372, 462, 455, 337, 204, 256, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 299, 98, 62, 338, 429, 40, 383, 128, 496, 247, 36, 215, 255, 293, 120, 282, 371, 444, 497, 452, 81, 414, 97, 434, 251, 25, 292, 263, 468, 277, 69, 421, 325, 400, 330, 295, 479, 298, 491, 99, 16, 271, 5, 395, 161, 458, 464, 205, 181, 54, 314, 425, 113, 188, 122, 498, 22, 348, 206, 127, 191, 105, 362, 77, 265, 254, 488, 195, 454, 284, 351, 233, 118, 377, 132, 281, 353, 15, 216, 192, 478, 289, 12, 17, 29, 116, 397, 93, 146, 245, 1, 493, 420, 270, 380, 409, 331, 79, 72, 134, 442, 196, 372, 338, 62, 427, 383, 165, 128, 255, 86, 177, 293, 282, 156, 211, 120, 444, 375, 371, 450, 97, 414, 168, 81, 266, 263, 4, 108, 25, 468, 251, 434, 292, 325, 491, 298, 421, 479, 330, 197, 295, 400, 69, 277, 395, 16, 161, 440, 205, 314, 54, 99, 271, 458, 464, 5, 436, 181, 498, 351, 122, 362, 234, 77, 488, 216, 265, 116, 454, 58, 284, 195, 254, 15, 132, 118, 353, 192, 281, 95, 12, 397, 478, 29, 93, 17, 403, 425, 105, 348, 377, 296, 318, 113, 6, 356, 289, 146, 233, 30, 94, 166, 225, 300, 299, 98, 442, 196, 372, 455, 337, 204, 256, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 94, 225, 98, 372, 455, 337, 204, 62, 338, 427, 250, 429, 383, 36, 247, 165, 128, 40, 496, 255, 86, 293, 38, 177, 211, 120, 282, 102, 156, 371, 375, 483, 444, 266, 450, 497, 168, 97, 414, 452, 81, 468, 108, 251, 434, 292, 263, 25, 4, 69, 295, 330, 421, 325, 491, 277, 197, 400, 298, 479, 181, 440, 436, 458, 205, 99, 464, 5, 271, 395, 161, 54, 16, 314, 377, 397, 93, 17, 425, 353, 348, 29, 95, 356, 478, 403, 6, 116, 58, 454, 498, 289, 296, 265, 318, 113, 15, 122, 234, 362, 30, 300, 299, 98, 196, 462, 455, 337, 256, 204, 62, 338, 250, 215, 165, 247, 383, 496, 40, 36, 255, 38, 293, 177, 86, 211, 102, 120, 282, 156, 375, 444, 483, 450, 266, 168, 497, 97, 452, 414, 81, 468, 251, 108, 434, 292, 25, 263, 4, 69, 330, 421, 325, 197, 491, 400, 277, 295, 298, 479, 181, 436, 458, 440, 205, 99, 54, 5, 464, 271, 161, 395, 16, 314, 377, 93, 397, 425, 95, 348, 29, 17, 356, 478, 265, 403, 116, 58, 454, 6, 289, 296, 318, 113, 353, 15, 122, 498, 234, 362, 30, 94, 166, 225, 300, 98, 442, 196, 372, 455, 462, 337, 204, 256, 62, 427, 429, 250, 40, 36, 496, 128, 383, 165, 247, 215, 255, 86, 177, 293, 38, 282, 102, 156, 120, 211, 371, 375, 444, 483, 168, 97, 414, 452, 266, 497, 450, 81, 263, 434, 468, 251, 25, 108, 292, 4, 325, 277, 330, 197, 491, 295, 400, 298, 479, 421, 69, 464, 54, 99, 5, 161, 205, 314, 395, 16, 271, 440, 181, 436, 458, 17, 95, 425, 403, 105, 116, 353, 29, 265, 15, 498, 284, 318, 296, 234, 58, 113, 6, 122, 300, 299, 442, 98, 196, 372, 455, 462, 337, 256, 204, 62, 338, 427, 429, 250, 36, 40, 215, 128, 165, 383, 496, 247, 255, 86, 38, 177, 293, 120, 282, 102, 156, 211, 375, 483, 444, 371, 497, 168, 414, 452, 450, 81, 266, 97, 251, 25, 434, 108, 263, 4, 468, 292, 479, 69, 330, 197, 325, 400, 298, 491, 295, 277, 421, 458, 271, 54, 464, 99, 5, 395, 314, 16, 161, 440, 205, 181, 436, 377, 397, 105, 95, 17, 348, 29, 265, 403, 425, 454, 234, 58, 289, 15, 284, 296, 318, 113, 498, 6, 299, 442, 196, 62, 250, 427, 429, 215, 36, 496, 40, 255, 293, 38, 156, 120, 211, 444, 371, 483, 266, 97, 81, 450, 414, 434, 251, 4, 263, 108, 25, 292, 330, 421, 325, 400, 295, 298, 491, 395, 440, 181, 314, 436, 205, 271, 99, 464, 95, 403, 296, 318, 234, 113, 6, 22, 191, 17, 122, 397, 206, 348, 105, 245, 127, 188, 362, 351, 265, 498, 195, 77, 289, 58, 488, 284, 15, 425, 146, 254, 353, 132, 118, 454, 377, 192, 281, 478, 93, 12, 356, 216, 233, 493, 420, 270, 380, 409, 79, 125, 299, 98, 372, 455, 337, 62, 338, 427, 250, 496, 36, 40, 128, 247, 255, 177, 293, 38, 156, 120, 282, 102, 444, 483, 371, 375, 450, 266, 168, 97, 497, 414, 25, 434, 108, 292, 4, 468, 251, 295, 400, 298, 69, 421, 330, 325, 491, 197, 479, 277, 16, 181, 436, 205, 54, 99, 464, 314, 271, 161, 5, 440, 395, 458, 216, 362, 234, 146, 58, 284, 15, 397, 6, 118, 281, 195, 12, 353, 425, 93, 478, 29, 95, 17, 348, 403, 356, 192, 116, 265, 296, 318, 113, 454, 122, 377, 498, 289, 105, 132, 300, 196, 455, 204, 62, 427, 165, 383, 247, 128, 255, 86, 177, 38, 293, 211, 282, 102, 371, 452, 450, 266, 81, 497, 263, 434, 292, 468, 251, 108, 25, 4, 277, 491, 69, 298, 197, 421, 400, 330, 5, 16, 436, 395, 205, 54, 314, 99, 271, 458, 181, 161, 188, 122, 265, 498, 234, 362, 191, 216, 348, 105, 116, 488, 127, 22, 289, 454, 58, 15, 77, 254, 233, 195, 146, 351, 29, 118, 245, 478, 95, 356, 17, 397, 6, 353, 403, 377, 425, 284, 296, 318, 113, 132, 206, 79, 125, 336, 319, 407, 30, 94, 166, 225, 300, 299, 442, 98, 372, 462, 455, 337, 256, 204, 338, 62, 427, 250, 429, 36, 128, 247, 496, 383, 165, 40, 215, 255, 86, 293, 38, 177, 282, 102, 156, 120, 211, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 263, 468, 251, 434, 25, 292, 108, 4, 277, 330, 325, 197, 400, 491, 295, 479, 298, 421, 69, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 94, 166, 225, 300, 299, 98, 442, 196, 372, 455, 462, 337, 256, 204, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 30, 166, 300, 98, 442, 196, 372, 462, 455, 337, 256, 204, 62, 338, 429, 250, 427, 383, 128, 36, 40, 496, 215, 165, 247, 86, 38, 177, 293, 282, 211, 102, 156, 120, 371, 375, 444, 483, 497, 97, 168, 414, 81, 266, 450, 452, 4, 251, 108, 434, 468, 25, 263, 292, 325, 330, 197, 277, 491, 295, 298, 479, 421, 69, 400, 458, 271, 54, 99, 464, 5, 161, 395, 16, 440, 205, 181, 436, 314, 377, 425, 95, 17, 348, 105, 403, 265, 116, 284, 58, 498, 15, 454, 296, 318, 113, 234, 6, 122, 353, 30, 94, 166, 225, 300, 299, 442, 196, 372, 462, 455, 337, 204, 256, 338, 62, 250, 427, 429, 128, 215, 247, 496, 165, 36, 40, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 371, 483, 444, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 30, 94, 225, 300, 98, 442, 196, 372, 462, 455, 337, 204, 256, 62, 338, 429, 427, 250, 383, 128, 40, 496, 215, 165, 36, 86, 38, 177, 293, 282, 120, 102, 156, 211, 371, 375, 483, 444, 497, 168, 97, 414, 81, 266, 452, 450, 4, 251, 108, 434, 468, 25, 263, 292, 325, 197, 330, 277, 491, 295, 298, 479, 421, 69, 400, 458, 271, 54, 99, 464, 5, 161, 395, 16, 440, 205, 181, 436, 314, 377, 425, 95, 17, 348, 105, 403, 265, 116, 284, 58, 498, 15, 454, 296, 318, 113, 234, 6, 122, 353, 30, 225, 300, 299, 442, 196, 372, 455, 462, 337, 204, 256, 338, 62, 427, 429, 250, 40, 383, 215, 247, 496, 165, 36, 128, 255, 86, 38, 177, 293, 282, 120, 211, 102, 156, 371, 375, 483, 444, 497, 168, 414, 97, 452, 266, 450, 81, 108, 4, 251, 434, 25, 263, 292, 468, 69, 325, 330, 197, 491, 295, 479, 298, 400, 421, 277, 271, 54, 464, 99, 5, 161, 395, 314, 16, 181, 440, 436, 458, 205, 377, 95, 425, 17, 403, 105, 29, 116, 265, 284, 15, 58, 296, 454, 318, 113, 498, 122, 234, 6, 30, 94, 225, 300, 299, 442, 98, 196, 372, 462, 455, 337, 204, 256, 338, 62, 250, 429, 427, 36, 128, 215, 40, 247, 496, 165, 383, 255, 86, 38, 293, 177, 282, 156, 120, 211, 102, 375, 483, 444, 371, 497, 168, 414, 97, 266, 452, 450, 81, 263, 4, 251, 434, 25, 468, 292, 108, 197, 330, 325, 400, 491, 295, 479, 298, 421, 69, 277, 464, 54, 271, 99, 5, 161, 205, 395, 314, 16, 181, 436, 458, 440, 425, 95, 17, 403, 116, 29, 289, 265, 15, 234, 296, 318, 498, 284, 113, 6, 122, 216, 94, 442, 98, 372, 462, 337, 256, 338, 62, 250, 427, 429, 215, 247, 496, 36, 165, 40, 383, 128, 255, 86, 177, 38, 293, 211, 156, 120, 282, 102, 371, 375, 444, 483, 266, 450, 497, 452, 97, 414, 168, 81, 468, 108, 251, 434, 292, 263, 25, 4, 295, 330, 421, 325, 491, 277, 400, 298, 69, 479, 181, 436, 458, 440, 205, 99, 464, 271, 5, 161, 54, 395, 16, 314, 377, 397, 93, 17, 425, 353, 348, 29, 95, 356, 478, 403, 6, 116, 58, 454, 318, 289, 296, 265, 113, 498, 15, 122, 234, 362, 462, 204, 256, 429, 383, 247, 165, 128, 86, 282, 102, 211, 483, 375, 371, 168, 452, 81, 414, 497, 251, 263, 468, 325, 421, 330, 69, 295, 197, 400, 298, 479, 464, 16, 436, 161, 271, 54, 5, 440, 205, 314, 395, 458, 234, 296, 318, 113, 498, 122, 362, 191, 188, 348, 105, 488, 233, 265, 116, 254, 245, 289, 58, 377, 284, 15, 216, 77, 206, 281, 353, 146, 132, 192, 118, 195, 95, 6, 29, 17, 356, 93, 403, 454, 397, 12, 22, 420, 270, 380, 409, 461, 79, 125, 336, 134, 499, 200, 319, 407]

        preds2 = exp.recommend(users = [1, 2], exclude_known=False)
        assert preds2['user'].unique().tolist() == [1,2]

        preds = exp.recommend(exclude_known=True)
        joined_preds = preds.join(
            data.set_index(['user', 'item']),
            on=['user','item'], how='inner'
        )
        assert len(joined_preds) == 0
